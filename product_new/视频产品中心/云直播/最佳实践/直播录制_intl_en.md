
LVB recording is a service that stores the files generated by encapsulating original streams (without modifying such information as audio and video data and corresponding timestamps) on the VOD platform.

## Recording Storage

As LVB recording files are stored on the VOD platform, to activate LVB recording, you need to apply for activation of the VOD service first.

## Recording Format

Supported recording formats include .flv, .hls, .mp4, and .aac (for audio recording).

## Recording Use Cases

- **Multi-level recording by push domain name and stream name**
    You can configure whether to record a stream at the push domain name and stream name level.

- **Recording within a specified time period**
    You can set the start time and end time through API calls to record a stream within the specified time period.

- **Real-time recording**
    You can record any frame of a stream in real time through API calls.
    
- **Audio recording**   
    You can configure audio recording in .acc format if the push is pure audio.

## Enabling Recording for All Live Streams under a Specified Push Domain Name

Recording parameters are managed in the form of templates. You can create recording configuration templates for different scenarios and flexibly manage the recording configuration by associating the templates with different push domain names and stream names.
After activating VOD, you can record live streams under a specified push domain name in two ways:

### LVB Console

1. On the [Recording Configuration](https://console.cloud.tencent.com/live/config/record) page, create a recoding configuration template.
2. On the [Domain Name Management](https://console.cloud.tencent.com/live/domainmanage) page, select a push domain name and click **Manage** to associate it with the template.

## API Call

1. Call [CreateLiveRecordTemplate](https://intl.cloud.tencent.com/document/product/267/30845) to set at least one recording format, such as FlvParam.
2. Call [CreateLiveRecordRule](https://intl.cloud.tencent.com/document/product/267/30846) to set the push domain name (DomainName) and TemplateId (returned in step 1) parameters. Enter an empty string in AppName and StreamName as a wildcard to indicate all streams under the domain name.

Likewise, you can associate the template with different stream names to record particular live streams.
In addition, as one template can be associated with different push domain names and stream names, one stream may be matched with multiple templates. In this case, the template with the highest priority will prevail. The priority rule of template matching is as shown below (which is for complex cases only and can be ignored by most users).

| DomainName | StreamName | Priority |
| --- | --- | --- |
| √ | √ | 0 |
| Null | √ | 1 |
| √ | Null | 2 |
| Null | Null | 3 |

Here, **Null** is a wildcard, **√** indicates exact match, and **0** represents the highest priority. Once a template with the highest priority is matched, the matching will be stopped and the corresponding template will be returned.

## Disabling Recording for Some Streams under a Specified Push Domain Name

When you have already configured recording for a push domain name but some streams under it do not need to be recorded, you can:

- Call [CreateLiveRecordTemplate](https://intl.cloud.tencent.com/document/product/267/30845) without specifying any recording format.

```
https://live.tencentcloudapi.com/?Action=CreateLiveRecordTemplate
&TemplateName=norecord
&Description=test
&<Common request parameter>
```

* Set DomainName and StreamName parameters in the console or through the [CreateLiveRecordRule](https://intl.cloud.tencent.com/document/product/267/30846) API and associate the above-mentioned recording template with the specified push domain name and stream name.

>This practice is applicable to scenarios where only a few streams do not need to be recorded. If there are too many of them, you are recommended to use another push domain name to manage them, because:
> - The allowed maximum number of recording templates or recording rules is 5.  
> - Management by push domain name is more flexible as recording templates and recording rules won't be affected in this mode even your business changes.

## Recording Within a Specified Time Period

For some streams, you can start and end recording at the specified time points through APIs. Unlike configuring a recording template, the recording parameters need to be specified through APIs. This approach is generally adopted if no recording method has been set.

API: [CreateLiveRecord](https://intl.cloud.tencent.com/document/product/267/30847)

In the simplest case, you only need to set the StreamName, StartTime, and EndTime parameters, for example:
```
https://live.tencentcloudapi.com/?Action=CreateLiveRecord
&StreamName=test
&StartTime=2018-09-11+08%3a00%3a00
&EndTime=2018-09-11+10%3a00%3a00
&<Common request parameter>
```

This creates a video recording task in .flv format for 8 am to 10am, September 11, 2018 with 30-minute segments that will be retained permanently.
The recording format, recording type, and storage parameters can also be specified, for example:

```
https://live.tencentcloudapi.com/?Action=CreateLiveRecord
&StreamName=test
&StartTime=2018-09-11+08%3a00%3a00
&EndTime=2018-09-11+10%3a00%3a00
&RecordType=audio
&FileFormat=mp4
&StreamParam=record_interval%3d3600%26storage_time%3d2592000
&<Common request parameter>
```

This creates a pure audio recording task in .mp4 format for 8 am to 10 am, September 11, 2018 with 1-hour segments that will be retained for one month.
>For the same live stream, there is no conflict between scheduled tasks or between a scheduled task and a recording task of another type. In other words, the time periods of multiple scheduled tasks can overlap, and the API can be called to create a recording task in addition to enabling a recording configuration.
>
It is recommended to create recording tasks in advance (e.g., one hour in advance or in the early morning for recording later on), and the task start time should be set to be a little earlier than the event start time.

> This calling method does not support recording overseas streams for the time being.

## Real-time Recording

If you want to record any frames immediately in the process of live streaming to generate highlight clips for future use, you can call the API to enable real-time recording.

```
https://live.tencentcloudapi.com/?Action=CreateLiveRecord
&StreamName=test
&MixStream=1
&EndTime=2018-09-11+10%3a00%3a00
&<Common request parameter>
```

The following notes on real-time recording need your attention:

- Make sure that the push is ongoing when you create a recording task.
- This is suitable for recording short clips of up to 30 minutes.
- You can call [StopLiveRecord](https://intl.cloud.tencent.com/document/product/267/30837) API to stop a task prematurely.
> This is supported for overseas streams.

## Stream Mixing-based Recording

First, please familiarize yourself with the stream mixing service in [Cloud Mixed Streaming](https://intl.cloud.tencent.com/document/product/267/8832).

For LVB scenarios where the cloud mixed streaming service is used, stream mixing is divided into two types by the OutputStreamType parameter on the recording side:
- If OutputStreamType = `0`, the output stream is in the input stream list, meaning that no new stream has been generated.
- If OutputStreamType = `1`, the output stream is not in the input stream list, meaning that a new stream has been generated.

Assume that streams A and B are output as stream C after stream mixing:
- If OutputStreamType = `0` and stream C has the same name as stream A with mixed video, after the recording configuration is started, a recording file mixing stream A (mixed video) and stream B will be generated by default. Note that as the same stream ID is reused, the original stream A will not generate a recording file.
- If OutputStreamType = `1`, after the recording configuration is started, a recording file mixing stream A, stream B, and stream C (mixed video) will be generated by default.

To record a mixed stream only, you can call the [CreateLiveRecord](https://intl.cloud.tencent.com/document/product/267/30847) API. It should be noted that if OutputStreamType =`1`, the MixStream parameter should be set to `1` when the API above is called.

## Auto-spliced Recording (Multi-stream Recording)
If a push is interrupted multiple times because of network jitters, a number of recording files will be generated, causing inconvenience to continuous playback of the live stream. To solve this problem, LVB recording can auto-splice multiple recording files during the same push into one single file.

This feature works by segmenting audio and video data by HLS' **#EXT-X-DISCONTINUITY** tag in HLS recording. This tag marks that the information such as timestamps of audio and video data, video encoding formats, audio encoding formats, and sample rates before and after it may be different. As such, the player needs to refresh the decoder for continuous playback. Therefore, to use this feature, the player must support the **#EXT-X-DISCONTINUITY** tag. Currently, the native player and Safari on iOS, ExoPlayer on Android, and hls.js player on the web support this tag, but VLC player does not support it.

After this feature is enabled, you need to set the auto-splicing interval (up to 5 minutes, meaning that recording files in intervals of up to 5 minutes can be spliced into one file). After the last push ends, the recording files before and after the interruptions will be automatically spliced to generate an HLS recording file.

Currently, auto-spliced recording is available only to the HLS format. You can set the auto-splicing timeout value in [Recording Configuration](https://intl.cloud.tencent.com/document/product/267/31070).
>This mode does not support live streams with no audio data.

## Getting a Recording File

The generated recording file is automatically stored in the VOD system and can be obtained in the following ways:

### VOD Console

Log in to the VOD Console and browse all recording files on the [Video Management](https://console.cloud.tencent.com/video/videomanage) page.

 ![](https://main.qcloudimg.com/raw/d3afc2a39fadc9ac889d68cfe52c71ef.png)

### Recording Event Notification

The recording callback address can be set in the console or through API calls, and you will receive the address in notification messages after the recording file is generated. After that, you can perform business processing according to the [callback protocol content](https://intl.cloud.tencent.com/document/product/267/31566) for recording.

The event notification mechanism is efficient, reliable, and real-time, so it is recommended to use the callback method to get recording files.

### VOD API Query
For detailed usage, see the VOD API documentation:
- The [SearchMedia](https://cloud.tencent.com/document/product/266/31813) API can be used to query the recording files by live stream name and time range.
- The [DescribeVodPlayInfo](https://cloud.tencent.com/document/product/266/7825) API can be used to get video information by video name prefix.

## Precautions for Configuration Update

After the recording configuration is updated, you are recommended to restart the push and verify the configuration. The validity rules for the configuration are as follows:

- It takes 10 minutes for the configuration to take effect by default.
- The configuration is effective upon the beginning of the LVB push and will not be updated in the process of recording.
- In scenarios where the push lasts for a long time such as surveillance recording, the push needs to be stopped and then restarted to make the configuration effective.
