## キャッシュ期限切れ構成とは？

- キャッシュ期限切れ構成とは、CDN加速ノードがユーザーのサービス内容をキャッシュするように構成する時に準拠する期限切れルールのセットです。CDNノードにキャッシュされているユーザーリソースは、いずれも「期限切れ」の問題に直面しています。
 - リソースが期限切れではない状態になっている場合、ユーザーリクエストがノードに到達すると、ノードは該当のリソースをユーザーに直接に返し、取得スピードを向上させます。
 - リソースが期限切れ状態になっている場合（即ち、設定された有効時間を超えた場合）、ユーザーリクエストはノードにオリジンサーバーに送信され、内容を再取得してノードにキャッシュする同時に、ユーザーに返します。
- Tencent Cloud CDNは、各次元での内容のキャッシュ時間設定、優先度のカスタマイズ、cache引継ポリシー（高度なキャッシュ構成）、404状態コードキャッシュ期限切れ設定およびHTTP Response headerキャッシュポリシー構成をサポートします。キャッシュ時間を適切に構成することは、命中率を効果的に向上させ、back to origin率を低下させ、ユーザーの帯域幅を節約することができます。

## 内容のキャッシュ

### 構成ガイド

1. [CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のメニューの【ドメイン名管理】をクリックし、編集するドメイン名の右側の【管理】をクリックします。
![](https://mc.qcloudimg.com/static/img/1f2cb594cd614b62b589cb20a20ed362/basic-config-1.png)
2. 【キャッシュ構成】をクリックし、**キャッシュ期限切れ構成**モジュールが表示されます。
![](https://mc.qcloudimg.com/static/img/eac99e580901b3fd9680c18c9807e4d9/cache-config-1.png)
3. ドメイン名アクセスの際、デフォルトの構成は次の通りです。
 - ユーザーオリジンのドメイン名の追加：すべてのファイルはデフォルトで30日のキャッシュ有効期限ですが、通常の動的ファイル（.php .jsp .asp .aspxなど）のキャッシュ有効期限はデフォルトで0であるため、このような動的ファイルリクエストに対しては直接にback to originします。
 - COSオリジンのドメイン名の追加：すべてのファイルはデフォルトでキャッシュ期限切れ時間が30日間です。
 - 高度なキャッシュ期限切れ構成がデフォルトでオフになっています。

### 構成の変更

【キャッシュ構成の追加】をクリックして、キャッシュ構成を追加できます。ユーザー自身のサービスニーズに応じて、デフォルトの構成にキャッシュ時間設定を追加できます。CDNは下記のようなキャッシュの期限切れ設定をサポートします。
 - **ファイルのタイプごとにキャッシュの期限切れを設定します。**
次に示すように、ファイルタイプのサフィックスを記入し、タイプに基づいてキャッシュ時間を設定できます。
![](https://mc.qcloudimg.com/static/img/3568205cb7d25892023298425694b965/cache-config-2.png)
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、内容は大文字と小文字を区別する必要があります。また、「.png」など、「.」で始まるファイルのサフィックスである必要があります。更新時間が0に設定されている場合、キャッシュをしなく、すべてのリクエストはユーザーオリジンサーバーに転送されます。キャッシュ時間設定の最大値は365日を超えてはいけません。
 - **フォルダー別にキャッシュの期限切れを設定します。**
次に示すように、フォルダーのパスを記入し、フォルダーに基づいてキャッシュ時間を設定できます。
![](https://mc.qcloudimg.com/static/img/e4c4fa6ba8d95c5d390cc54ad191cc10/cache-config-3.png)
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、中身では大文字と小文字を区別する必要があります。また、「/」で始まるフォルダーでなければなりません。更新時間が0に設定されている場合、キャッシュしをなく、すべてのリクエストはユーザーのオリジンサーバーに転送されます。キャッシュ時間設定の最大値は365日を超えてはいけません。
 - **すべてのパスファイルにキャッシュの期限切れを設定します。**
特定のファイルのためにキャッシュ時間を次のように設定できます。
![](https://mc.qcloudimg.com/static/img/e8743ead4c1b90f399090fb037a7acc5/cache-config-4.png)
キャッシュ時間を構成するには、複数の項目を記入し、各項は「;」で区切り、内容は大文字と小文字を区別する必要があります。「*」が「/test/abc/*.jpg」などの特定のタイプのファイルにマッチングすることをサポートします。
![](https://mc.qcloudimg.com/static/img/92919f03ed7c846a874b7f28c5495aee/cache-config-5.png)
 - **トップページのためにキャッシュの期限切れを設定します。**
トップページを指定してキャッシュ時間を次のように設定できます。![](https://mc.qcloudimg.com/static/img/d90e94fe31d4265fe8123c9e9ba99c51/cache-config-7.png)

### 優先度

1. 複数のキャッシュポリシーが設定されている場合、互いに重複することがあります。

>! 構成項目の優先度はリストの上から下へ優先度が順に高くなります。

 特定のドメイン名は下記のようにキャッシュが構成されていると仮定します。
 -すべてのファイルが30日間

 -  .php .jsp .aspx 0秒
 -  .jpg .png .gif 300秒
 -  /test/*.jpg 400秒
 -  /test/abc.jpg 200秒

2. ドメイン名が「www.test.com」であり、リソースが「www.test.com/test/abc.jpg」であると仮定すると、そのマッチング方式は次の通りです。

 - 1番目のすべてのファイルにマッチングし、命中しました。この時、キャッシュ時間は30日です。
 - 2番目にマッチングし、命中していません。
 - 3番目にマッチングし、命中しました。この時、キャッシュ時間は300秒です。
 - 4番目にマッチングし、命中しました。この時、キャッシュ時間は400秒です。
 - 5番目にマッチングし、命中しました。この時、キャッシュ時間は200秒です。

だから、最終のキャッシュ時間が200秒で、最後のマッチングで有効となります。

3. 【優先度の調整】をクリックしてキャッシュ構成を追加できます。ユーザーは、サービス状況に応じて追加されたキャッシュの期限切れ構成の順序をカスタマイズで調整できます。
![](https://mc.qcloudimg.com/static/img/7e36e2c35ee168ce4a1be2bc24a09532/cache-config-8.png)
4. 右側の上矢印と下矢印を使用してキャッシュの期限切れ構成の順番を調整し、[保存]をクリックして調整を完了します。
![](https://mc.qcloudimg.com/static/img/6b8cef4cac9bf1e53842f8ca448076aa/cache-config-9.png)

### キャッシュ引継

お客様が特定のサービスリソースをリクエストすると、オリジンサーバーに対応するResponse HTTP HeaderにCache-Controlフィールドが存在します。この時、デフォルトのポリシーは次の通りです。
- Cache-Controlフィールドはmax-ageであり、このリソースに対するキャッシュ時間は構成されているキャッシュ時間に準じ、max-ageの指定時間の引継しません。

- Cache - Controlフィールドはno - cacheまたはno - storeである場合、CDNノードはこのリソースをキャッシュしません。
- Cache - Controlフィールドがない場合、CDNはデフォルトで「Cache - Control: max - age = 600」ヘッダーを追加します。

### 高度なキャッシュ構成

1. キャッシュの期限切れ構成モジュールで**高度なキャッシュ期限切れ設定**スイッチがあります。このスイッチをクリックして開きます。
![](https://mc.qcloudimg.com/static/img/a5a7e3a5975ec71238bf8b5eeefdc5f2/cache-config-6.png)
2. 高度なキャッシュ期限切れ設定スイッチをオンにすると、ユーザーがオリジンサーバーのあるリソースをリクエストする時、Response HTTP Header にCache-Controlフィールドが付き、値が「max-age=xxxx」です。この時、ノードは構成されている有効期限時間とmax-ageの中の最小値を該当リソースのキャッシュ時間として取ります。

 - ユーザーのオリジンサーバーで「/index.html」のmax-ageが200秒、CDNに対応するキャッシュ時間が600秒に構成されると、ファイルの実際の期限切れ時間は200秒となります。
 - ユーザーのオリジンサーバーで「/index.html」のmax-ageが800秒、CDNに対応するキャッシュ時間が600秒に構成されると、ファイルの実際の期限切れ時間は600秒となります。

## ヘッダーキャッシュ

リソースがノードでキャッシュに命中すると、CDNはデフォルトで下記のオリジンサーバーヘッダーからのものをキャッシュし、ユーザーに返します。

- Access - Control - Allow - Origin
- Timing - Allow - Origin
- Content - Disposition
- Accept - Ranges 

[ドメイン名管理]の[キャッシュ構成]モジュールに移動し、[オリジンサーバーのすべてのヘッダーをキャッシュする]機能を手動で有効にすると、CDNはすべてのオリジンサーバーをキャッシュしてヘッダー情報を返します。


## ステータスコードのキャッシュ

1. ノードがオリジンサーバーのリソースをリクエストする場合、上記のキャッシュポリシー以外に、ステータスコードに基づいて下記のデフォルトキャッシュポリシーに従って行います。

 - 2XX：通常のキャッシュポリシーに従って行います。
 - 3XX：デフォルトでキャッシュしません。
 - 4XX：404が10sキャッシュし、他はデフォルトでキャッシュしません。
 - 5XX：デフォルトでキャッシュしません。

2.  [キャッシュ構成]の[ステータスコードキャッシュ]モジュールで404のキャッシュ時間を調整できます。
   ![](https://mc.qcloudimg.com/static/img/bb35a0a9c828ad2e8ec4e48e1dcf8bf0/cache-config-11.png)
   404の状態コードキャッシュ時間を0～3600秒に調整できます。

>! ファイルに対応するキャッシュのキャッシュ期限切れ時間が0である場合、404が生成されても、キャッシュをしない原則に準拠し、直接にパススルーします。
