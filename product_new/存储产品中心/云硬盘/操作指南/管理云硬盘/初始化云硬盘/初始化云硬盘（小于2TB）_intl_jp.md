## ユースケース
このドキュメントはCBSの容量が2TB未満の場合を例として、CBSの初期化操作を説明します。ディスクの初期化処理の詳細については、 [初期化処理の紹介](https://intl.cloud.tencent.com/document/product/362/31596)をご参照ください。


## 前提条件
>
>- データディスクをフォーマットすることによりすべてのデータがクリアされるため、データディスクにデータを保存しないか、重要なデータがバックアップされたことを確認してください。
>- サービス異常を回避するために、フォーマットを実行する前に、CVMが外部へのサービスを停止したことを確認してください。
>
CVMに[CBSをマウント](https://intl.cloud.tencent.com/document/product/362/32401)しました。

## 操作手順

<span id="Windows2008"></span>
### CBSの初期化（Windows）
> このドキュメントは Windows Server 2008 OSを例として、OSによってフォーマット操作が異なる場合があり、このドキュメントはあくまで参考です。

1. [ Windows CVMにログインします](https://intl.cloud.tencent.com/document/product/213/5435)。
2. CVMのデスクトップで、【開始】をクリックします。
3. スタートメニューの【コンピュータ】を右クリックし、【管理】を選択します。
4. 左側のナビゲーションバーで、【ストレージ】>【ディスク管理】を選択します。【ディスク管理】の画面にアクセスします。

> 新規ディスクがオフライン状態である場合（上図に示すように）、まず[ステップ5](#online) を実行し、オンラインにした後 [ステップ6](#initialize) を実行して、初期化を行います。それ以外の場合は [ステップ6](#initialize) を直接実行して、初期化を行います。

<span id="online"></span>
5. 右側のペインにディスクリストが表示されますので、ディスク1領域を右クリックし、メニューリストで【オンライン】を選択し、オンライン処理を行います。オンラインした後、ディスク1は【オフライン】状態から【未初期化】に変換します。
 
<span id="initialize"></span>
6. ディスク1領域を右クリックし、メニューリストで【ディスクの初期化】を選択します。
7. 【ディスクの初期化】ダイアログボックスで初期化するディスクが表示され、【MBR（マスターブートレコード）】あるいは【GPT（GUID パーティションテーブル）】を選択して、【OK】をクリックします。
> ディスクの使用が開始した後、ディスクパーティション形式を置き換え、ディスクの元のデータが全部クリアされるため、実際の需要に応じてパーティション形式を合理的に選択します。
>
8. ディスク上のアサインされていない領域を右クリックし、【シンプルボリュームの新規作成】を選択します。
9. 【シンプルボリューム新規作成のガイド】ダイアログボックスで、インターフェースプロンプトに従って、【次へ】をクリックします。
10. 実際の状況に応じてボリュームサイズを指定し、デフォルトは最大値であり、【次へ】をクリックします。
11. ドライバー番号をアサインし、【次へ】をクリックします。
12. 【下記の設定手順に従ってボリュームをフォーマットする】を選択し、実際の状況に応じて、パラメータを設定し、新しいパーティションをフォーマットし、【次へ】をクリックして、パーティションの作成を完成します。
13. 【完成】をクリックして、ガイドラインを完成します。初期化を完成させるまでしばらく待つ必要があり、ボリュームのステータスが[状態良好]の場合、ディスクの初期化が成功したことを示します。
  初期化が成功した後、【コンピューター】のインターフェースで新しいディスクを確認できます。
<span id="Linux"></span>
### CBSの初期化（Linux）

実際のユースケースによって初期化方式を選択します：
- ディスク全体が一つ独立したパーティションを表示している場合（つまり、vdb1やvdb2などの複数の論理ディスクがない場合）、パーティションを使用しないで直接[ベアデバイスでファイルシステムを構築](#CreateFileSystemOnBareDevice)することをお勧めします。
- ディスク全体が複数の論理パーティションを表示している場合、（つまり、複数の論理ディスクが存在する場合）、まずパーティション操作を実行し、次に[パーティションにファイルシステムの構築](#CreateFileSystemOnPartition)処理を行います。

<span id="CreateFileSystemOnBareDevice"></span>
#### ベアデバイスでファイルシステムを構築する

1. [ Linux CVM にログインします](https://intl.cloud.tencent.com/document/product/213/5436)。
2. rootユーザーとして以下のコマンドを実行して、ディスクの名称を確認します。
 ```
fdisk -l
```
 返却情報は下図に示すように、該当CVMでは2つのディスクがあり、「/dev/vda」はシステムディスクであり、「/dev/vdb」は新規データディスクです。
 ![](https://main.qcloudimg.com/raw/aad842b12fec3ca583790bff609c9fb7.png)
3. 以下のコマンドを実行して、「/dev/vdb」というベアデバイスにファイルシステムフォーマットを直接作成します。
```
mkfs -t <ファイルシステムフォーマット> /dev/vdb
```
異なるファイルシステムは異なるサイズのパーティションをサポートし、実際の要求に応じて、ファイルシステムを合理的に選択します。ファイルシステム`EXT4` を例として、次を実行する：
```
mkfs -t ext4 /dev/vdb
```
> フォーマットを実行している時、しばらく待つ必要があります。システムの実行状態を確認し、終了しないでください。
4. 以下のコマンドを実行し、新しいマウントポイントを作成します。
```
mkdir <マウントポイント>
```
新規マウントポイント `/data` を例として、次を実行する：
```
mkdir /data
```
5. 以下のコマンドを実行し、新規パーティションを新規マウントポイントにマウントします。
```
mount /dev/vdb <マウントポイント>
```
新規マウントポイント `/data` を例として、次を実行する：
```
mount /dev/vdb /data
```
6. 以下のコマンドを実行して、マウント結果を確認します。
```
df -TH
```
> スタートアップする時、ディスクが自動的にマウントされるように設定する必要がない場合は、次の手順をスキップしてください。
7. マウント方式を確認し、関連する情報を取得します。
業務の要求に応じて、Elastic CBS のソフトリンク、ファイルシステム UUID（universally unique identifier）あるいはデバイスの名称を使用して、ディスクを自動的にマウントし、関連する説明と情報の取得方法は以下の通り：
<table>
 <tr>
      <th>マウント方法</th>
      <th>メリットとデメリット</th>
      <th>情報の取得方法</th>
 </tr>
 <tr>
     <td nowrap="nowrap">Elastic CBSのソフトリンクを使用する<b>（おすすめ）</b></td>
     <td><b>メリット</b>：各Elastic CBS のソフトリンクは固定されて唯一であり、マウント、アンマウントやパーティションのフォーマットなどの操作によって変更されません。</br><b>デメリット</b>：Elastic CBSのみソフトリンクがあります。パーティションのフォーマット操作を感知できません。</td>
		 <td nowrap="nowrap">以下のコマンドを実行して、Elastic CBSのソフトリンクを確認します。</br><pre>ls -l /dev/disk/by-id</pre></td>
	</tr>
	<tr>
	   <td nowrap="nowrap">ファイルシステムのUUIDを使用する</td>
		 <td>ファイルシステムUUIDの変更により、自動マウントの設定が無効になっている可能性があります</br>例えば、ファイルシステムを再フォーマットすると、ファイルシステムのUUID が変更されます。</td>
		 <td nowrap="nowrap">以下のコマンドを実行して、ファイルシステムのUUIDを確認します。</br><pre>blkid /dev/vdb</pre></td>
  </tr>
	<tr>
	   <td nowrap="nowrap">デバイスの名称を使用する</td>     
		 <td>デバイス名称の変更により、自動マウントの設定が無効になっている可能性があります。</br>例えば、データマイグレーションを実行する場合、CVM上のElastic CBSをアンマウントして再度マウントすると、OS はファイルシステムを再度認識する時に名称が変更される可能性があります。</td>
		 <td nowrap="nowrap">以下のコマンドを実行して、デバイスの名称を確認します。</br><pre>fdisk -l</pre></td>
 </tr>
</table>
8. 以下のコマンドを実行して、 `/etc/fstab`  ファイルをバックアップします。 /home ディレクトリの配下にバックアップすることを例として、次を実行する：
```
cp -r /etc/fstab /home
```
9. 以下のコマンドを実行して、 VIエディタを利用して`/etc/fstab` ファイルを開きます。
```
vi /etc/fstab
```
10. **i** を押して、編集モードに入ります。
11. カーソルをファイルの最後に移動し、**Enter**を押して、以下の内容を追加します。
```
<デバイス情報> <マウントポイント> <ファイルシステムのフォーマット> <ファイルシステムのインストールオプション> <ファイルシステムのダンプ頻度> <起動する時のファイルシステムのチェック順序>
```
 - **（おすすめ）**Elastic CBS のソフトリンクを使用して自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
```
/dev/disk/by-id/virtio-disk-drkhklpe /data ext4 defaults 0 0
```
 - ディスクパーティションのUUIDを使用する自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
```
UUID=d489ca1c-5057-4536-81cb-ceb2847f9954 /data  ext4 defaults     0   0
```
 - デバイスの名称を使用する自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
```
/dev/vdb /data   ext4 defaults     0   0
```
12. **Esc**を押し、**:wq**を入力し、**Enter**を押します。 
設定を保存して、エディターを終了します。
13. 以下のコマンドを実行して、**/etc/fstab** ファイルへの書き込みは成功したかどうかを確認します。
```
mount -a 
```
操作が成功すると、ファイルは正常に書き込まれ、OSが起動する時に新規ファイルシステムが自動的にマウントされます。

<span id="CreateFileSystemOnPartition"></span>
#### パーティションでファイルシステムを構築する

> この操作はCentOS 7.5 OSでfdisk パーティションツールを使用して、データディスク `/dev/vdb`をプライマリパーティションに設定し、パーティションの形式はデフォルトで MBRに設定し、ファイルシステムのフォーマットはEXT4に設定し、`/data/newpart`の配下にマウントして、スタートアップする時に自動マウントを設定することを例として説明します。各OSのフォーマット操作が異なるため、このドキュメントはあくまで参考です。
>

1. [ Linux CVM にログインします](https://intl.cloud.tencent.com/document/product/213/5436)。
2. rootユーザーとして以下のコマンドを実行して、ディスクの名称を確認します。
 ```
fdisk -l
```
 返却情報は下図に示すように、該当CVMでは2つのディスクがあり、「/dev/vda」はシステムディスクであり、「/dev/vdb」は新規データディスクです。
 ![](https://main.qcloudimg.com/raw/aad842b12fec3ca583790bff609c9fb7.png)
3. 以下のコマンドを実行して、fdiskパーティションツールにアクセスし、新規データディスクにパーティション操作を実行します。
 ```
fdisk <新規データディスク>
```
 新しくマウントされたデータディスク`/dev/vdb`を例として、次を実行する：
 ```
fdisk /dev/vdb
```
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/db1fe212e2559ac635c52e5e397e7531.png)
4. `n`を入力し、**Enter**を押し、新しいパーティションを作成します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/c89b572c0ac2af1302189f8e7e1a849e.png)
 ディスクに2つ種類のパーティションがあることを示します：
  - 【p】はプライマリパーティションを示します。
  - 【e】は拡張パーティションを示します。
5. プライマリパーティションを作成することを例として、`p`を入力し、**Enter**を押し、プライマリパーティションを作成します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/efb65b60631d95e9b0213e6fd6125bbb.png)
 【Partition number】はプライマリパーティションの番号を示し、1-4を選択できます。
6. パーティション番号1の選択を例として、プライマリパーティションの番号`1`を入力し、**Enter**を押します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/e1a1a7755a3bb392ec6d623e6774c315.png)
 【First sector】は初期のセクター領域を示し、2048 - 20971519を選択でき、デフォルトでは2048となります。
7. 例えば、デフォルトで初期のセクターの番号2048を選択し、**Enter**を押します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/58a8202531b239a73fd3182d0ea0cf34.png)
 【Last sector】は最後のセクター領域を示し、2048 - 20971519を選択でき、デフォルトでは20971519となります。
8. デフォルトで最後のセクタリージョン番号20971519を例として、**Enter**を押します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/ad3a6459a6eaf154aed578b37dfc89d0.png)
 パーティションが完成したことを示します。つまり、60GBのデータディスクに新しいパーティションを作成しました。
9. `p`を入力し、**Enter**を押して、新規パーティションの詳細情報を確認します。
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/98427c11e0a181e02eb23a95fc1e908c.png)
 新規パーティション`/dev/vdb1`の詳細情報を表示します。

>上記のパーティション操作が正しくない場合、`q`を入力し、fdisk パーティションツールを終了し、この前のパーティション処理結果は保存されません。

10. `w`を入力し、**Enter**を押し、パーティション結果をパーティションテーブルに書き込みます。
 返却情報は下図に示すように、パーティションの作成が完成したことを示します。
 ![](https://main.qcloudimg.com/raw/7011369be260150fcddf272b4a4ab2fa.png)
11. 以下のコマンドを実行して、新しいパーティションテーブルの変更をOSに同期します。
 ```
partprobe
```
12. 以下のコマンドを実行して、新規パーティションのファイルシステムをシステムに必要なフォーマットに設定します。
 ```
mkfs -t <ファイルシステムのフォーマット> /dev/vdb1
```
 各ファイルシステムがサポートしているパーティションのサイズも異なり、実際の要求に応じて、ファイルシステムを合理的に選択してください。ファイルシステムをEXT4に設定することを例として、次を実行する：
 ```
mkfs -t ext4 /dev/vdb1
```
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/6de097cea77634f8847816dd795292a7.png)
 フォーマットを実行している時、しばらく待つ必要があります。システムの実行状態を確認して、終了しないでください。
13. 以下のコマンドを実行し、新しいマウントポイントを作成します。
 ```
mkdir <マウントポイント>
```
 新規マウントポイント`/data/newpart`の作成を例として、次を実行する：
 ```
mkdir /data/newpart
```
14. 以下のコマンドを実行し、新規パーティションを新規マウントポイントにマウントします。
 ```
mount /dev/vdb1 <マウントポイント>
```
 新規マウントポイント`/data/newpart`の作成を例として、次を実行する：
 ```
mount /dev/vdb1 /data/newpart
```
15. 以下のコマンドを実行して、マウント結果を確認します。
 ```
df -TH
```
 返却情報は下図に示すように：
 ![](https://main.qcloudimg.com/raw/b7e5501fed8d7d648b48dc66685baf94.png)
 新規パーティション`/dev/vdb1`が`/data/newpart`にマウントされていることを示します。
 
> スタートアップする時にディスクの自動マウントを設定する必要がない場合、次の手順をスキップしてください。
>
16. マウント方式を確認し、関連する情報を取得します。
 業務の要求に応じて、Elastic CBS のソフトリンク、ファイルシステム UUID（universally unique identifier）あるいはデバイスの名称を使用して、ディスクを自動的にマウントし、関連する説明と情報の取得方法は以下の通り：
 <table>
     <tr>
         <th>マウント方法</th>  
         <th>メリットとデメリット</th>  
         <th>情報の取得方法</th>  
     </tr>
	   <tr>      
         <td nowrap="nowrap">Elastic CBS のソフトリンクを使用する<b>（おすすめ）</b></td>   
	       <td><b>メリット</b>：各Elastic CBS のソフトリンクは固定されて唯一であり、マウント、アンマウントやパーティションのフォーマットなどの操作によって変更されません。<br><b>デメリット</b>：Elastic CBS のみソフトリンクがあります。 パーティションのフォーマットを感知できません。</td>
	       <td nowrap="nowrap">以下のコマンドを実行して、Elastic CBSのソフトリンクを確認します。</br><pre>ls -l /dev/disk/by-id</pre></td>
     </tr> 
	   <tr>      
         <td nowrap="nowrap">ファイルシステムのUUIDを使用する</td>   
	       <td>ファイルシステムのUUIDの変更により、自動マウントの設定を無効になっている可能性があります。<br>例えば、ファイルシステムを再フォーマットすると、ファイルシステムのUUIDが変更されます。</td>
	       <td nowrap="nowrap">以下のコマンドを実行して、ファイルシステムのUUIDを確認します。</br><pre>blkid /dev/vdb1</pre></td>
     </tr> 
	   <tr>      
         <td nowrap="nowrap">デバイスの名称を使用する</td>   
	       <td>デバイス名称の変更により、自動マウントの設定が無効になっている可能性があります。<br>例えば、データマイグレーションを実行する場合、CVM上のElastic CBSをアンマウントして再度マウントすると、OSはファイルシステムを再度認識する時に名称が変更される可能性があります。</td>
	       <td>以下のコマンドを実行して、デバイスの名称を確認します。</br><pre>fdisk -l</pre></td>
     </tr> 
</table>
17. 以下のコマンドを実行して、`/etc/fstab ファイル`をバックアップします。/home ディレクトリの配下にバックアップすることを例として、次を実行する：
```
cp -r /etc/fstab /home
```
18. 以下のコマンドを実行して、VIエディターを利用して、`/etc/fstab`ファイルを開きます。
 ```
vi /etc/fstab
```
19. **i**を押して、編集モードに入ります。 
20. カーソルをファイルの最後に移動し、**Enter**を押して、以下の内容を追加します。
 ```
<デバイス情報> <マウントポイント> <ファイルシステムのフォーマット> <ファイルシステムのインストールオプション> <ファイルシステムのダンプ頻度> <起動する時のファイルシステムのチェック順序>
```
 - **（おすすめ）**Elastic CBSのソフトリンクを使用する自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
 ```
/dev/disk/by-id/virtio-disk-drkhklpe-part1 /data/newpart   ext4 defaults     0   2
```
 - ディスクパーティションのUUID を使用する自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
```
UUID=d489ca1c-5057-4536-81cb-ceb2847f9954 /data/newpart   ext4 defaults     0   2
```
 - デバイスの名称を使用する自動マウントを例として、前文の例に合わせて、以下の内容を追加します：
```
/dev/vdb1 /data/newpart   ext4 defaults     0   2
```
20. **Esc**を押し、**:wq**を入力し、**Enter**を押します。
 設定を保存して、エディターを終了します。
21. 以下のコマンドを実行して、`/etc/fstab`ファイルへの書き込みが成功したかどうかを確認します。
```
 mount -a 
```
操作が成功すると、ファイルは正常に書き込まれ、OSが起動する時に新規作成されたファイルシステムが自動的にマウントされます。

## 関連操作
[CBSの初期化（2TB以上）](https://intl.cloud.tencent.com/document/product/362/31598)

