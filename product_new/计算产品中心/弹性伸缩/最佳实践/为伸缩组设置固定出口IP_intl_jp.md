このセクションは「クラスターは自主的な外部アクセスが必要とされる場合、固定外部アクセスIPの設定方法」について紹介します。

## 需要シナリオ

スケーリンググループ中のクラスターは以下の３つのニーズが同時に存在する場合：
- Cloud Load Balancerからリクエストを受けること
- クラスターCVMは自主的な外部アクセスが必要であること
- 外部にアクセスする時、**固定**のパブリックIPが希望されること

次のソリューションに従って設定します。

## ソリューション概要
1. Cloud Load Balancer CLBを通して、外部からのリクエストを受信と対応します。
2. CVMをVPCのサブネットに設置し、ルートテーブルをNAT Gatewayへ指定して、自主的な外部アクセスのリクエストは統一的にNAT GatewayのパブリックIPから発信します。
3. スケーリンググループのネット属性を当該サブネットに設定し、スケールアウトされたCVMは統一的にNAT Gatewayを通して自主的に外部アクセスを行います。

下図に示すように：

![](https://mc.qcloudimg.com/static/img/9cccdddfe99dbc065c97cad27448ed9f/image.png)



## 設置方法

### ステップ1： VPCとサブネットを作成する

#### **1. VPCを作成する**

1. [Tencent Cloud コンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバーにある【Virtual Private Cloud】をクリックします。あるいはTencent Cloudの[VPCの紹介画面](https://cloud.tencent.com/product/vpc.html)にアクセスし、【今すぐ体験】ボタンをクリックして、[VPCコンソール](https://console.cloud.tencent.com/vpc/)にアクセスします。

2.リストにあるドロップダウン・リスト中のリージョンを選択し、【新規作成】をクリックして、VPCを作成します。例えば、「華北リージョン（北京）」を選択します。

3.Virtual Private Cloudとサブネット名とCIDRを記入し、サブネットのアベイラビリティーゾーンを選択します。

4.【作成】をクリックします。


#### **2. サブネットを作成する**

1. [Tencent Cloud コンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバーにある【Virtual Private Cloud】をクリックして、ナビゲーションバーの左側にある【サブネット】をクリックします。ドロップダウン・リスト中のリージョンとVPCを選択します。
![](https://main.qcloudimg.com/raw/8c04a129eabe941ad8ef9758347e028f.png)

2. 【新規作成】をクリックし、サブネット名、CIDR、アベイラビリティーゾーンと関連ルートテーブルを記入します。そして【作成】をクリックして確認します。

3. 「新規作成」を完成した後、このサブネットにCVMを購入できます。


### ステップ2：NAT Gatewayを作成する
#### **1. 購入する**
1. [Tencent Cloud コンソール](https://console.cloud.tencent.com/)にログインし、【Virtual Private Cloud】タブを選択して、【NAT Gateway】を選択します。

2. 左上の角にある【新規作成】ボタンをクリックし、ポップアップボックスに以下のパラメータを順次に入力または確定します：
	- ゲートウェイ名
	- ゲートウェイタイプ（ゲートウェイタイプが作成されると変更できます）
	- NAT GatewayサービスのVirtual Private Cloud（先ほど作成したVPC）
	- NAT GatewayにElastic IPをアサインし、このIPはCVMが外部にアクセスする時の固定IPです。

3. 選択を完成した後【OK】ボタンをクリックすると、NAT Gatewayの作成を完成できます。

4. NAT Gatewayを作成した後、サブネットのトラフィックをNAT Gatewayへ指定するために、Virtual Private Cloudコンソールのルートテーブル画面にルート規則を設定する必要があります。

#### **2. ルートテーブルを設定する(重要)**
1. [Tencent Cloud コンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバーにある【Virtual Private Cloud】ボタンをクリックし、[Virtual Private Cloud コンソール](https://console.cloud.tencent.com/vpc/vpc?rid=8)にアクセスして、【ルートテーブル】を選択します。

2. ルートテーブルリストの中で、インターネットにアクセスする必要があるサブネットに関連するルートテーブルIDをクリックして、ルートテーブルの詳細画面に入り、ルーティングポリシーにある【編集】ボタンをクリックします。

3. 【新しい行を追加する】をクリックし、目的アドレス（例えばこの場合“0.0.0.0/0”を記入）を記入します。次ホップのタイプは【NAT Gateway】を選択し、すでに作成されたNAT Gateway IDを選択して、最後は「OK」をクリックします。
![](https://main.qcloudimg.com/raw/e5029e42a6570c26814375f2264a7f4b.png)

ここまで、当該サブネットにあるCVMは、パブリックネットワークIPがなくても、NAT Gatewayを通して自主的に外部へアクセスでき、対外的にはまだ固定IPです。

下図に示すように、パブリックネットワークIPがなく、帯域幅は「0」のホストを購入した場合でも、自主的に外部へアクセスできます：
![](https://mc.qcloudimg.com/static/img/17ed153e06272885b56764781d9ab581/49.jpg)
しかし、スケーリンググループはこのサブネットを識別する必要があって、CVMはこのサブネットに作成されたことを確保する必要もあります。

### ステップ3：スケーリンググループを設定する
このステップの目的はサブネット情報をスケーリンググループへ指定し、スケーリンググループはスケールアウトされた新しいCVMをこのサブネットに設定します。
**そうすると、スケールアウトされたCVMは自動的にNAT GatewayのIPアドレスで外部にアクセスすることにより、出口IPを固定する効果が得られました。**

[Auto Scaling コンソール](https://console.cloud.tencent.com/autoscaling/config)で、「新規作成」をクリックします：

- スケーリンググループ名、起動設定（事前に設定する必要がある）、最大スケーリング数、最小スケーリング数、初期インスタンス数などの情報を記入します
- 「ネットワーク」と「サブネット」を選択し、先ほど設定したVPCとサブネットへ指定します**（重要）**。

下図に示すように：
![](https://main.qcloudimg.com/raw/f752a1ae61b9a49c97d50626f33f76da.png)

ここまですべての設定は完了しました。
