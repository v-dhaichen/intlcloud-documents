## 仮想化クライアントマシンのシャットダウンプロセスの分析

### シャットダウンプロセス
Tencent CloudのWindowsインスタンスのシャットダウンプロセスは下記の通り：
1. ホストマシンのlibvirtはshutdownコマンドをqmpプロトコルを通してqemuコンポーネントに転送します。
2.qemuコンポーネントはshutdownコマンドをacpi中断方式に注入することによってCVMに転送します。（詳細は vmcsに関連する技術ドキュメントをご覧ください）。
3. Windowsインスタンスはシャットダウンシグナルを受信した後、アプリケーションとサービスプロセスに終了するよう通知します。
4. コアサービスプロセスを停止します。
5. 電源をオフします。
> その中、ステップ３とステップ４は、システム構成によって、各アプリケーションとサービスの停止順序が異なる可能性があります。

Windows はクローズドソースOSであり、いくつの API を提供することによってカーネルおよびユーザープログラムがシャットダウンプロセスに関与できるようにします。同時に Windows自体の一部実行中のサービスがシャットダウンプロセスに影響するため、コンピューターがシャットダウンできなくなります。そのため、Windowsのシャットダウンプロセスは時間がかかる場合があります。

### ハードシャットダウン
仮想化の場合、メッセージ通知を利用してWindows自体をシャットダウンする以外、他のインスタンス停止方法も提供しています。物理マシンの電源を切るのと類似方法であり、このシャットダウン方法を**ハードシャットダウン**と呼びます。システムシグナルによるシャットダウン操作は、**ソフトシャットダウン**と呼ばれます。
ハードシャットダウンはWindows自身とユーザー体験とも影響があります。主な影響は下記の二パターンがあります：
1. ハードシャットダウンはあるサービスとアプリケーションプを中断したため、これらのプログラムが正常に動作しない可能性があります。例えば、保存していないドキュメント、完了していないWindowsUpdateプロセスなどがあります。
2. WindowsのNTFSシステム（または以前のFAT32などのシステム）はシャットダウンプロセス中でいくつかの重要なデータを書き込むため、ハードシャットダウンによってこれらの重要なデータがディスクに書き込めないと、WindowsがNTFSファイルシステムが破壊していると判断する可能性があります。

上記の理由に基づき、Tencent Cloudのユーザーは**ソフトシャットダウンを優先利用**してWindows インスタンスをシャットダウンすることを推薦します。

## シャットダウン失敗のいくつかのユースケース
Windows OSにいくつかの問題があるため、シャットダウンプロセスが影響を受け、正常にシャットダウン場合があります。シャットダウン失敗は下記のユースケースを含むがこれらに限定されません。
1. WindowsUpdateプロセスにより、シャットダウン時間が延長される場合があります。Windowsが特定のパッチ操作を実行する場合、OSをシャットダウンする時にいくつかの処理を行います。この時、「コンピューターの電源を切ったり、電源コードを抜いたりしないでください」旨のプロンプトメッセージが画面に表示されます。
2. Windows OSが「シャットダウンイベントの追跡」メカニズムを実施している場合、OSのサービスとドライバープログラムがエラー発生してシャットダウンする時、OSはコンフィグレーションにより、ユーザーにプロンプ​​トボックスを表示するか、エラーの説明を入力させて、ユーザーがこれらの操作を完了してから、電源をオフします。ユーザーが指定された操作を完了するまで、Windowsは電源をオフにしません。
3. Windowsはユーザーがシステムにログインしていない場合、シャットダウンを許可しないように設定します。この場合、仮想化ホストから送信されたソフトシャットダウンコマンドがWindowsに破棄されるため、シャットダウンすることができません。
4. Windowsはシャットダウンする時、すべてのサービスとアプリケーションプにメッセージをブロードキャストします。これらのプログラムがこのメッセージを受信した後、停止できる応答を返さない場合、シャットダウン処理は実行されません。この場合、Windowsは関連設定を行ってこのプロセスを無視します。
5. Windows電源管理に関連する操作の中、【電源がオフになったときのWindowsの処理方法】を無視するかまたは操作しないように設定する場合、Windows は仮想化ホストマシンのシャットダウンイベントを無視します。
6. Windowsは電源管理の設定によってスリープ状態になる時、シャットダウンイベントを処理しません。
7. Windows OSに悪意のあるソフトウェアをインストールした場合、又はトロイの木馬、ウイルスなどを感染した場合、Windows OS環境自体は破壊されたため、Windowsのシャットダウンがブロックされる可能性があります。

Tencent CloudはWindowsパブリックイメージをリリースしたとき、上記のほとんどのユースケースを最適化して、ソフトシャットダウンをスムーズに完了できるようになりました。ただし、これらの最適化対策では、Windowsがウイルス又はトロイの木馬を感染した場合やOSが破壊された場合などのユースケースを解決できません。また、ユーザーのWindowsインスタンスの関連設定を再度調整しても、ソフトシャットダウンがスムーズに実行することを保証できません。
**強制的なシャットダウンはリスクがあるため、どうしても必要な場合のみハードシャットダウンを実行することを推薦します。**
