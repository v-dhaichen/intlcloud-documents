## 操作シナリオ
本ドキュメントはCentOS 7.2 64ビットシステムを例とし、vsftpdをFTPサービス側とし、FileZillaをクライアントとすることにより、Linux CVMでFTPサービスを構築する方法について説明します。

## 操作手順
###  vsftpdのインストール
1.  Linux CVMにログインします。
2. 下記のコマンドを実行し、 vsftpdをインストールします。
``` 
yum install vsftpd -y
```

### サービスの実行
1. 下記のコマンドを実行し、サービスを実行します。
```
systemctl start vsftpd
```
2. 下記のコマンドを実行し、サービスが実行されているかどうかを確認します
```
netstat -tunlp
```
下記のような情報が戻された場合、 vsftpdサービスの実行に成功したことを示しています。
![](http://mc.qcloudimg.com/static/img/6cc74de5689106ce763be98bfe7f5d24/image.png)

### （オプション） vsftpd サービスの検証
>  FTPサービス側が順調にコンフィギュレーションすることを確保するために、ローカルコンピューター又はほかのCVMで下記のような操作手順を行うことにより、vsftpdサービスの実行に成功したかどうかを再度検証することが可能です。下記の操作手順はLinux OSのローカルコンピューターを例とします。ローカルコンピューターがWindows/Mac OS である場合は、当該コンピューターでtelnet機能がオンになっていることを確保してください。
>
1. ローカルコンピューターのOSインターフェースで下記のコマンドを実行し、telnetサービスをインストールします。
> ローカルコンピューターが Windows/Mac OSである場合は、この手順をスキップしてください。
>
```
yum -y install  telnet
```
3. 下記のコマンドを実行し、 vsftpd サービスの実行に成功したかどうかをテストします。
```
telnet + CVMパブリック IP + 21
```
下記のような情報が戻された場合は、サービスの実行に成功したことを示しています。
![](https://main.qcloudimg.com/raw/47ad66d7be133b6d69d60c3e5b719dbd.png)

<span id = "jump">  </span>

###  vsftpdのコンフィギュレーション
1. 下記のコマンドを実行し、 vsftpdのコンフィギュレーションファイルを開きます。
```
vi /etc/vsftpd/vsftpd.conf
```
2.  「**i**」又は「**Insert**」をクリックし、編集モードに切り替え、ファイルにおける`anonymous_enable=YES`を`anonymous_enable=NO`に変更します。下図の通りです。
![](http://mc.qcloudimg.com/static/img/4e7770981eae42e7b16a2a5a7866a6a6/image.png)
3.  「**Esc**」をクリックし、「**:wq**」を入力し、ファイルを保存してから戻ります。

###  FTP ユーザーの追加
1. 下記のコマンドを実行し、ユーザー`ftpuser1`を追加します。
``` 
useradd -m -d /home/ftpuser1 -s /sbin/nologin ftpuser1
```
2. 下記のコマンドを実行し、ユーザー`ftpuser1`のパスワードを設定します。
```
passwd ftpuser1
```
ユーザーの新規作成、ユーザーパスワードの設定に成功しました。下図の通りです。
![](https://main.qcloudimg.com/raw/eec9ba9d188bf8b82a846fed73e02b52.png)

## 後続操作
 FTPサービスの構築が完了した後に、それを介してファイルをアップロード・ダウンロードすることができます。例えば、[ FTP経由でWindowsマシンのファイルアップロード](https://intl.cloud.tencent.com/document/product/213/2132)です。

## よくある問題
### FTPクライアントの接続タイムアウト又はディレクトリリストの読取失敗
#### 問題の説明
一部のユーザーがローカルでFTPクライアント接続を利用する時に、接続タイムアウトとディレクトリリスト読取失敗の問題が出る可能性があります、下図の通りです。
![](https://main.qcloudimg.com/raw/7ce40abf194d65604b2ee73aa34e0fe7.png)
PASVコマンドに問題が発生しました、原因はTencent CloudネットワークアーキテクチャにおけるFTPプロトコルの不具合にあります。FTP クライアントはパッシブモード転送をデフォルトとしているため、通信中にサーバー側のIPアドレスを見つけ接続しますが、Tencent CloudのパブリックIPは直接にENIに配置されていないので、パッシブモードではクライアントが有効的なIPを見つけられません （CVMのプライベートIPしか見つけられない。プライベートIPは直接にパブリックネットワークと通信できない）。そのため、接続を確立することができません。

#### 解決方法
1. クライアントの伝送モードを主動に変更すればよいです。
2. クライアントのネットワーク環境がパッシブモードを要求する場合は、サービス側で [vsftpdコンフィギュレーション](#jump) におけるコンフィギュレーションファイルに下記のセンテンスを追加する必要があります。
```
pasv_address=XXX.XXX.XXX.XXX     //(パブリックIP)
pasv_enable=YES
pasv_min_port=1024
pasv_max_port=2048
```

### FTPクライアントのファイルアップロードの失敗
#### 問題の説明

Linuxシステム環境では、vsftp経由でファイルをアップロードする時に、下記のようなエラー情報が示されます。
```
553 Could not create file
```

#### 解決方法
1. 下記のコマンドを実行し、サーバーのディスクスペースの利用率をチェックします。
```
df -h
```
 - ディスクスペースが足りない場合は、ファイルをアップロードできないため、ディスクにおける大容量のファイルを削除することをお薦めします。
 - ディスクスペースが正常である場合は、次のステップを実行してください。
2. 下記のコマンドを実行し、 FTP ディレクトリに書き込み権限があるかどうかをチェックします。
```
ls -l /home/test      
# /home/testがFTP ディレクトリです。実際のFTPディレクトリに修正してください。
```
 - 戻された結果に `w`がない場合は、当該ユーザーに書き込み権限がないことを示し、次のステップを実行してください。
 - 戻された結果に `w`があった場合は、 [作業依頼書を提出](https://console.cloud.tencent.com/workorder/category) しフィードバックしてください。
3. 下記のコマンドを実行し、 FTPディレクトリに書き込み権限をを追加します。
```
chmod +w /home/test 
# /home/testがFTPディレクトリです。実際のFTP ディレクトリに修正してください。
```
4. 下記のコマンドを実行し、書き込み権限の設定が成功しているかどうかを再度チェックします。
```
ls -l /home/test   
# /home/testがFTP ディレクトリです、実際のFTPディレクトリに修正してください。
``` 




