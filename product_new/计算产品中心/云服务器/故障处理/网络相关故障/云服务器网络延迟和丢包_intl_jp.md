## 問題の説明
ローカルでCVMにアクセスするか、あるいはCVMで他のネットワークリソースにアクセスする時にインターネットのラグが発生しました。`ping`コマンドを使用して、パケットロスや高いレイテンシーを発見しました。

## 問題の分析
バックボーンリンクの輻輳、リンクノードの故障、サーバー負荷が高い、システムの設置問題などの原因により、パケットロスや高いレイテンシーを引き起こす可能性があります。CVM自体のの原因を除外した後、MTRを使用してより詳細な診断を行うことができます。
MTRはネットワーク診断ツールであり、このツールで診断されたレポートを通じて、ネットワーク問題が発生する原因を確認することができます。

## ソリューション
> このドキュメントはLinuxおよびWindows CVMを例として、MTRの使用方法とMTRレポートの結果の分析方法について説明します。
>
MTRを実行しているホストOSに応じて、MTRの紹介と使用方法をご参照てください。
- [WinMTR の紹介と使用方法（Windows OS）](#MTRofWindows)
- [MTR の紹介と使用方法（Linux OS）](#MTRofLinux)

<span id="MTRofWindows"></span>
### WinMTR の紹介と使用（Windows OS）
**WinMTR：**はWindows に適応する無料なインターネット診断ツールであり、Pingとtracertのすべての機能を統合し、グラフィカルインターフェースがあり、各ノードの応答時間とパケットロスの状況を確認することができます。

#### WinMTRをインストールする
1. Windows CVMをログインする。
2. OSインターフェースで、ブラウザーで公式Webサイト（または合法的なチャネル）にアクセスし、対応するOSタイプのWinMTRインストールパッケージをダウンロードする。
3. WinMTRインストールパッケージを解凍/圧縮する。

#### WinMTRの使用
1. WinMTR.exeをダブルクリックして、WinMTRツールを開く。
2. WinMTR ウインドウの Host で、宛先サーバーのIPまたはドメイン名を入力し、【Start】をクリックします。下図に示すように：
![](https://main.qcloudimg.com/raw/7aa2d2e76b86deabd6d0248ecf89de56.png)
3. 実際の状況に応じて、WinMTRが一定の時間で実行していた後、【Stop】をクリックして、テストを終了します。下図に示すように：
![](https://main.qcloudimg.com/raw/5d73f806c0252d26755d584e874c26f1.png)
テスト結果の情報は以下の通り：
 - **Hostname**：宛先サーバーに経由した各ホストIPまたは名称です。
 - **Nr**：経由したノード数です。
 - **Loss%**：対応するノードのパケットロス率です。
 - **Sent**：送信したデータパッケージ数です。
 - **Recv**：受信した応答数です。
 - **Best**：最短の応答時間です。
 - **Avrg**：平均応答時間です。
 - **Worst**：最長の応答時間です。
 - **Last**：直近の応答時間です。

<span id="MTRofLinux"></span>
### MTR の紹介と使用（Linux OS）
**MTR：**Linuxプラットフォームでインターネットを診断するツールで、Ping、traceroute、nslookup の機能を承継して、デフォルトでICMP パッケージを利用して二つのノードの間のネットワーク接続状態をテストします。

####  MTRをインストールする
既存のLinux が発行したバージョンは事前にMTRをインストールしました。Linux CVMはMTRをインストールしていない場合は、以下のようなコマンドを実行してインストールします：
- CentOS OS：
```
yum install mtr
```
- Ubuntu OS：
```
sudo apt-get install mtr
```

#### MTR 相関パラメータの説明
- **-h/--help**：ヘルプメニューを表示する
- **-v/--version**：MTR のバージョン情報を表示する
- **-r/--report**：結果はレポートとして出力する
- **-p/--split**：**--report** と対照し、毎回のトレース結果をリストする
- **-c/--report-cycles**：毎秒で発送するデータパッケージの数を設置し、デフォルトでは10となる
- **-s/--psize**：パッケージのサイズを設置する
- **-n/--no-dns**：IPアドレスに対してドメイン名の解析を行わない
- **-a/--address**：ユーザーはデータパッケージの発送IPアドレスを設定します、重要ユーザーが単一のホスト上に複数のIPアドレスをもつケース
- **-4**：IPv4
- **-6**：IPv6

#### ユースケース
ローカルでIPが119.28.98.39のサーバーを例とします。
以下のコマンドを実行して、レポートとしてのMTRの診断結果を出力します。
```
mtr 119.28.98.39 -- report
```
以下のような情報が返される：
```
[root@VM_103_80_centos ~]# mtr 119.28.98.39 -- report
Start: Mon Feb  5 11:33:34 2019
HOST:VM_103_80_centos            Loss%    Snt    Last    Avg    Best    Wrst    StDev
1.|-- 100.119.162.130             0.0%     10     6.5    8.4     4.6    13.7      2.9
2.|-- 100.119.170.58              0.0%     10     0.8    8.4     0.6     1.1      0.0
3.|-- 10.200.135.213              0.0%     10     0.4    8.4     0.4     2.5      0.6
4.|-- 10.200.16.173               0.0%     10     1.6    8.4     1.4     1.6      0.0
5.|-- 14.18.199.58                0.0%     10     1.0    8.4     1.0     4.1      0.9
6.|-- 14.18.199.25                0.0%     10     4.1    8.4     3.3    10.2      1.9
7.|-- 113.96.7.214                0.0%     10     5.8    8.4     3.1    10.1      2.1
8.|-- 113.96.0.106                0.0%     10     3.9    8.4     3.9    11.0      2.5
9.|-- 202.97.90.206               30.0%     10    2.4    8.4     2.4     2.5      0.0
10.|-- 202.97.94.77               0.0%     10     3.5    4.6     3.5     7.0      1.2
11.|-- 202.97.51.142              0.0%     10   164.7    8.4   161.3   165.3      1.2
12.|-- 202.97.49.106              0.0%     10   162.3    8.4   161.7   167.8      2.0
13.|-- ix-xe-10-2-6-0.tcore2.LVW 10.0%     10   168.4    8.4   161.5   168.9      2.3
14.|-- 180.87.15.25              10.0%     10   348.1    8.4   347.7   350.2      0.7
15.|-- 180.87.96.21               0.0%     10   345.0    8.4   343.4   345.0      0.3
16.|-- 180.87.96.142              0.0%     10   187.4    8.4   187.3   187.6      0.0
17.|-- ???                      100.0%     10     0.0    8.4     0.0     0.0      0.0
18.|-- 100.78.119.231             0.0%     10   187.7    8.4   187.3   194.0      2.5
19.|-- 119.28.98.39               0.0%     10   186.5    8.4   186.4   186.5      0.0
```
主な出力情報は以下のように：
- **HOST：**ノードのIP アドレスまたはドメイン名です。
- **Loss%：**パケットロス率です。
- **Snt：**毎秒で発送したデータパッケージの数です。
- **Last：**直近の応答時間です。
- **Avg：**平均応答時間です。
- **Best：**最短の応答時間です。
- **Wrst：**最長の応答時間です。
- **StDev：**の標準偏差、偏差値は大きいほど、各データパッケージが該当ノードでの応答時間の差が大きくなる。

### レポートの結果分析と処理
> ネットワーク状態の非対称性のため、ローカルからサーバーへ通信する時、ネットワークの問題が発生した場合は、双方向のMTRデータ（ローカルからCVMへ、CVMからローカルへ）を収集することをお勧めします。
>
1. レポートの結果により、宛先サーバーIPはパケットロスが発生したかどうかを確認する。
 - 宛先サーバーはパケットロスが発生していない場合は、ネットワークの接続は正常です。
 - 宛先サーバーはパケットロスが発生した場合は、[ステップ2](#step02)を実行してください。
2. <span id="step02">上にあるレポートの結果を表示して、パケットロスが初めて発生したノードを定める。</span>
 - 宛先サーバーでパケットロスが発生した場合は、原因は宛先サーバーのネットワークの設定が不適切であることにより、宛先サーバーのファイアウォールの設定を確認してください。
 - パケットロスが最初の三ジャンプで発生した場合は、ローカルキャリアのネットワークの問題であるため、その時は他のアドレスにアクセスする時も同じ問題があるかどうかをチェックしてください。同じ問題が存在する場合は、キャリアに問い合わせください。
 - パケットロスが宛先サーバーの直近の何ジャンプで発生した場合は，宛先サーバーのキャリアのインターネット問題である可能性があります、[作業依頼書を提出](https://console.cloud.tencent.com/workorder/category)して、フィードバック処理を実行してください。
 作業依頼書を提出する時に、エンジニアが確認できるように、ローカルから宛先サーバーまで、または宛先サーバーからローカルまでのMTRテストのスクリーンキャプチャを添付してください。
