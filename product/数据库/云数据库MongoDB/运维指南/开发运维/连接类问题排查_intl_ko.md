MongoDB를 사용하는 과정에서 주요 두 가지 유형의 연결 문제가 발생합니다. 참조 할 수 있는 해결 아이디어는 아래에 설명되어 있습니다.
## 연결 사용률이 높음 ##
사용 과정에서 인스턴스의 연결 사용률이 높은 것을 발견했을 경우, 다음과 같은 절차로 문제를 점검할 수 있습니다.<br>
1. 비즈니스에 연결 풀을 사용했는지 확인하십시오.<br>
MongoDB의 서비스 모드는 각 인터넷 연결이 단일 스레드로(one-thread-per-connection) 처리하는 것입니다. 인터넷 연결 수가 매우 많은 경우, 대량의 스레드로 인해 컨텍스트 전환 비용이 많아지고 메모리 비용도 함께 높아집니다. 각 요청은 연결 및 인증을 진행하면 성능에 영향을 미칠 수 있습니다. 따라서, 인스턴스의 연결 수를 제한하고 사용한 후에 릴리스하려면 비즈니스에 연결 풀을 사용하는 것을 권장합니다. 또한, MongoDB 각 언어의 드라이브는 기본적으로 한 개체를 캡슐화합니다. 사용할 때 전역 개체를 구축하여 후속 요청에서 해당 전역 개체로 요청을 인스턴스에 발송합니다. 드라이브의 개체에 연결 풀에 대한 기본적인 크기가 있으며 개체 구축 시, maxPoolSize 옵션에서 연결 풀의 크기를 설정할 수도 있습니다.<br>

2. 연결 풀을 이미 설정했다면 비즈니스에 돌발적인 이상이 발생했는지 점검하십시오.
 - 비즈니스에 릴리스 변경 및 코드의 논리적 결함이 있는지 확인하십시오. 이는 다량의 연결을 일으킬 수 있습니다.<br>
 - 연결 누출 상황이 있는지 점검하십시오. 관련 CVM에서 연결 수에 이상이 있는지 통계하십시오.<br>
 - 비즈니스에 다량 실제 돌발적인 요청이 있는지 확인하십시오.<br>

3. 스로우 로그로 인해 연결을 차지했는지 확인하십시오.<br>
 - 비즈니스에 이상이 없는 경우, 인덱스에 이상이 있는지 확인하십시오(예: 기존의 인덱스를 실수로 삭제하는 경우 등).<br>
 -  인덱스에 이상이 없는 경우 현재 대량 스로우 로그가 있는지 확인하십시오. 스로우 로그로 인해 연결을 늘 차지하고 릴리스하지 못하여 더 많은 연결을 생성할 것입니다.<br>
[TencentDB for MongoDB 콘솔](https://console.cloud.tencent.com/mongodb)에 로그인하여, 인스턴스의 스로우 로그를 확인하십시오. 추상 조회를 선택할 수 있습니다. 자세한 내용은 다음과 같습니다.<br>
![](https://main.qcloudimg.com/raw/19a7b1568cf38f6b493cb5088cfdff93.png)
command, COLLSCAN, IXSCAN, keysExamined, docsExamined 등 키워드를 유의하십시오. 로그에 관한 더 많은 설명은 [MongoDB 공식 웹사이트](https://docs.mongodb.com/manual/reference/log-messages/index.html)를 참조하십시오. <br>
   주의해야 할 키워드는 다음과 같습니다.<br>
 1. command는 스로우 로그에 기록한 작업을 표시합니다.<br>
 2. COLLSCAN은 해당 조회가 전체 테이블을 스캔하는 것을 의미합니다. IXSCAN은 인덱스로 스캔하는 것을 의미합니다. 필드에 대한 더 많은 설명은 [MongoDB 공식 웝사이트](https://docs.mongodb.com/manual/reference/explain-results/index.html)를 참조하십시오.<br>
 3. keysExamined는 인덱스 스캔 항목을 의미합니다. docsExamined는 문서 스캔 항목을 의미합니다. 더 큰 keysExamined와 docsExamined는 인덱싱이 없다는 것을 의미하거나 인덱스의 구분도가 높지 않음을 의미합니다. 인덱스에 대한 생성 필드를 확인하십시오.<br>
4. 포그라운드에서 인덱스를 생성하기 때문에 요청이 잠겨 있는지 확인하십시오.<br>
비즈니스 조회에 사용되는 인덱스에 문제가 없다면, 비즈니스 피크 기간에 포그라운드에서 인덱스를 생성했는지를 확인하십시오. 집합이 인덱스를 생성할 때, 기본적으로 포그라운드 방식(백그라운드 옵션 값: False)을 사용합니다. 해당 조작은 포그라운드에서 인덱스 생성을 완료할 때까지 다른 모든 작업을 차단합니다. 백그라운드 방식으로 인덱스를 생성하면 인덱스 생성 시간 동안 MongoDB가 정상적으로 읽기/쓰기 작업 서비스를 제공할 수 있습니다. 그러나, 이 방식으로 인덱스를 생성하면 인덱스 생성 시간이 길어집니다. 인덱스 생성 옵션에 대한 자세한 설명은 [MongoDB 공식 웹사이트](https://docs.mongodb.com/manual/reference/method/db.collection.createIndex/)를 참조하십시오.<br>
currentOp 명령을 통해 현재 인덱스의 진행 상황을 확인할 수 있습니다. 구체적인 명령은 다음과 같습니다.


	 db.currentOp(
        {
          $or: [
            { op: "command", "query.createIndexes": { $exists: true } },
            { op: "insert", ns: /\.system\.indexes\b/ }
          ]
        }
        )
반환값은 다음과 같습니다. msg 필드는 현재 인덱스의 진행 상황을 의미하며 locks 필드는 해당 작업의 잠금 유형을 의미합니다. 잠금 기능에 관한 더 자세한 설명은 [MongoDB 공식 웹사이트](https://docs.mongodb.com/v3.2/reference/database-profiler/)를 참조하십시오.<br>
![](https://main.qcloudimg.com/raw/355b6c06539ad6a5e3980b90bd200bf0.png)
![](https://main.qcloudimg.com/raw/155583329a2eb2a99575a2b5ce0b8647.png)<br>
5. 인스턴스 구성이 비즈니스 요구에 충족되는지 평가하십시오.<br>
연결 풀을 사용하고 구분도가 높은 인덱스를 구축한 후 콘솔에 비즈니스의 연결 사용률을 아직 높은 것을 모니터링한다면 인스턴스의 구성이 비즈니스의 실제 수요에 총죽하지 않을 수 있습니다. 이 때는 비즈니스의 유형, 트래픽 피크값, QPS와 TPS 등에 따라 실제 필요한 인스턴스 사양 구성을 평가하는 동시에 요구에 따라 인스턴스를 업그레이드할 수도 있습니다.

## 연결 거부 ##
실제로 사용하는 과정에서 연결 거부 상황이 발생하면, 다음 절차를 참조하여 문제를 점검하십시오.<br>
1. 인스턴스 연결 사용률이 100%에 도달했는지 확인하십시오.
[TencentDB for MongoDB 콘솔](https://console.cloud.tencent.com/mongodb)에 로그인하여, 콘솔의 연결 수 및 연결 사용률 모니터링 메트릭을 확인하십시오. 다음 그림과 같습니다.<br>
![](https://main.qcloudimg.com/raw/b1a5ef8d203696142bd17c2427668bab.png)

 인스턴스 연결 사용률이 100%에 도달했다면 비즈니스 자체에 이상이 있는지 점검하십시오. 한편, 긴급 상황에서는 콘솔에서 mongos를 다시 시작하여 연결을 빠르게 릴리스할 수 있습니다.
>! mongos를 다시 시작하면 모든 인스턴스의 연결을 다시 시작하는 순간에 중단합니다. 그러나 비즈니스를 다시 연결하면 됩니다. 비즈니스에 대해 지속적인 영향을 끼치지 않습니다. 다시 시작한 후 비즈니스 연결 수가 신속하게 증가하여 연결 사용률이 100%에 도달하면 비즈니스에 다량의 유효한 연결이 있다는 것이 확실합니다. 이것은 연결 누출이 아닙니다. 이 때는 먼저 비즈니스에 다량 연결이 발생한 원인을 찾아내야 합니다. 연결 사용률이 높은 문제 관련 점검 방법을 참조할 수 있습니다.

2. 사용자 이름과 비밀번호가 정확한지 확인하십시오.
사용자 이름과 비밀번호를 올바르게 입력하십시오. 틀렸다면 콘솔에서 변경하시기 바랍니다. [관리] > [계정 관리]로 이동하십시오. 자세한 내용은 다음과 같습니다.<br>
![](https://main.qcloudimg.com/raw/1b505172b773dd5ebeb5f129eb1c790c.png)

3. Mongoshell 버전을 확인하십시오.
인증 성공을 보장하기 위해 Mongo Shell 3.0 및 이상 버전을 설치하십시오. 설치 절차는 [공식 문서](https://docs.mongodb.com/v3.2/installation/)를 참조하십시오.<br>
4. 인증 데이터베이스가 정확한지 확인하십시오.<br>
>!공식 웹사이트 콘솔에서 생성한 사용자의 경우 해당 인증 데이터베이스는 모두 admin입니다. 따라서 사용자는 로그인할 때, 인증 데이터베이스를 admin으로 지정해야 합니다. 명령행으로 생성한 사용자의 경우(예: test 데이터베이스에서 생성한 사용자, 로그인할 때 인증 데이터베이스는 test로 지정해야 합니다) 해당 인증 데이터베이스는 모두 명령행으로 지정됩니다.
