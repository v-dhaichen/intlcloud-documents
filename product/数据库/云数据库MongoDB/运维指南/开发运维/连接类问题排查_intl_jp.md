MongoDBの使用中にしばしば次の2種類の接続問題が発生する可能性があります。以下、参考になるトラブルシューティングの方法を紹介します。
## 接続使用率が高い ##
使用中にインスタンスの接続使用率が高いと判明した場合、次のステップを参照して問題をトラブルシューティングできます。<br>
1. 業務が接続プールを使用したか確認します。<br>
MongoDBのサービスモデルは各ネットワーク接続が単独のスレッド（one-thread-per-connection）によって処理されます。ネットワークの接続数が多い場合、過量のスレッドによりコンテキスト切替のコストも大きくなり、メモリコストもそれに従い増加します。リクエストするたびに接続と認証を行うことは性能に大きく影響します。そのため、インスタンスの接続数を制限して使用が完了した接続を適時にリリースする必要があります。この場合、業務中に接続プールの使用をお勧めします。また、MongoDBの各语言のDriverには基本的に1つのオブジェクトがカプセル化されています。使用するときに1つのグローバルオブジェクトを構築して、その後のリクエストにおいてこのグローバルオブジェクトを用いてリクエストをインスタンスに送信する必要があります。Driverのオブジェクトにはデフォルトの接続プールサイズがあり、オブジェクトを構築するときにmaxPoolSizeオプションを定義して接続プールのサイズを設定できます。<br>

2. 接続プールが既に設定された場合、業務に予期しない異常が存在しないかチェックしてください。
 - 業務の変更がリリースされたか、コードロジックの欠陥による大量の接続確立が存在するか確認してください。<br>
 - 接続漏洩がないか、関連CVMの統計検査接続数について異常がないかチェックしてください。<br>
 - 業務に大量の真実で予期しないリクエストがあるかどうかを確認してください。<br>

3. スロークエリによる接続占用があるかどうかをチェックしてください。<br>
 - 業務異常がないことを確認できれば、索引の異常があるかチェックしてください。例えば、その前に作成した索引が誤って削除されたなど。<br> 
 - 索引の異常がなければ、現時点で大量のスロークエリがあるかどうかをチェックしてください。スロークエリによって接続が使用されているままリリースされない状態になるため、より多くの接続が確立されます。<br>
[TencentDB for MongoDBコンソール](https://console.cloud.tencent.com/mongodb)にログインし、インスタンスのスローログを確認し、下図に示すように、抽象クエリを選択できます。<br>
![](https://main.qcloudimg.com/raw/19a7b1568cf38f6b493cb5088cfdff93.png)
command、COLLSCAN、IXSCAN、keysExamined、docsExaminedなどのキーワードに注意してください。その他のログについては、[MongoDB公式サイト](https://docs.mongodb.com/manual/reference/log-messages/index.html)を参照してください。 <br>
   以下のキーワードに注意してください。<br>
 1. commandはスローログに記録される操作を指し示します。<br>
 2. COLLSCANはこのクエリによる全テーブルスキャン、IXSCANは索引スキャンを示します。その他のフィールドの記述については、[MongoDB公式サイト](https://docs.mongodb.com/manual/reference/explain-results/index.html)を参照してください。<br>
 3. keysExaminedは索引スキャンエントリを示し、docsExaminedはドキュメントスキャンエントリを示します。keysExaminedとdocsExaminedが多いほど、索引が作成されていない可能性または索引の差別が小さい可能性が高くなります。索引の作成フィールドを確認してください。<br>
4. フォアグラウンドでの索引の作成によりリクエストがロックされるかどうかを確認してください<br>
業務のクリエに使用される索引に問題が存在しない場合、現時点で業務の忙しい時間帯にフォアグラウンドの索引作成操作を行ったかどうかを確認してください。1つのセットに索引を作成するときにフォアグラウンド方式（backgroundの値がfalse）がデフォルト方式であれば、この操作が他のすべての操作をフォアグラウンドの索引作成完了までブロックします。バックグラウンド方式で索引を作成する場合、索引を作成する期間に、MongoDBが依然として読み取り・書き込み操作サービスを正常に提供できますが、バックグラウンドの索引作成方式にも欠点があります。すなわち、バックグラウンド方式の索引作成は索引作成時間を長くする場合があります。具体的な索引作成オプションについては、[MongoDB公式サイト](https://docs.mongodb.com/manual/reference/method/db.collection.createIndex/)を参照してください。<br>
currentOpコマンドで現在索引を作成する進捗を確認できます。具体的なコマンドを次に示します。

   
	 db.currentOp(
        {
          $or: [
            { op: "command", "query.createIndexes": { $exists: true } },
            { op: "insert", ns: /\.system\.indexes\b/ }
          ]
        }
        )
戻り値は下図のとおりです。msgフィールドが現在索引を作成する進捗を示し、locksフィールドがこの操作のロックタイプを示します。その他のロックについては、[MongoDB公式サイト](https://docs.mongodb.com/v3.2/reference/database-profiler/)を参照してください。<br>
![](https://main.qcloudimg.com/raw/355b6c06539ad6a5e3980b90bd200bf0.png)
![](https://main.qcloudimg.com/raw/155583329a2eb2a99575a2b5ce0b8647.png)<br>
5. インスタンス構成が業務ニーズに対応できるかどうかを評価します。<br>
接続プールを使用し大きい差別の索引を作成した後に、コンソールのモニタから業務の接続使用率がなお高いことを確認した場合、インスタンスの構成が業務の実際的なニーズに対応できない可能性があります。この場合、自社の業務モデル、トラフィックピーク値、QPSとTPSなどのニーズにより実際に必要なインスタンス規格の構成を評価し、必要に応じてインスタンスをアップグレードする必要があります。

## 接続拒否 ##
実際的に使用するときに接続拒否が発生した場合、次のステップを参照して問題をトラブルシューティングしてください。<br>
1. インスタンスの接続使用率が100%に達したか確認します。
下図に示すように、[TencentDB for MongoDBコンソール](https://console.cloud.tencent.com/mongodb)にログインし、コンソールの接続数と接続使用率の監視指標を確認します。<br>
![](https://main.qcloudimg.com/raw/b1a5ef8d203696142bd17c2427668bab.png)

 インスタンスの接続使用率が100%であれば、自社の業務に異常が存在するかどうかをトラブルシューティングします。また、緊急事態の場合、コンソールでmongosを再起動して速やかに接続をリリースできます。
>! mongosを再起動するとインスタンスのすべての接続が再起動の一瞬で中断されます。業務を再接続すればよいので、業務に影響し続ける可能性がありません。再起動後に業務の接続数が迅速的に増加し、接続使用率が再び100%に達した場合、業務に確実に大量の有効な接続が存在し、接続漏洩のシナリオではありません。この場合、大量の接続が発生する業務の原因を調べる必要があります。接続使用率が高いという問題のトラブルシューティング方法を参照してください。

2. ユーザー名とパスワードが間違っているかどうかを確認します。
ユーザー名とパスワードの正確性を確保してください。間違っている場合、下図に示すように、コンソールの【管理】->【アカウント管理】で変更します。<br>
![](https://main.qcloudimg.com/raw/1b505172b773dd5ebeb5f129eb1c790c.png)

3. Mongoshellのバージョンを確認します。
認証に合格するには、Mongo Shell 3.0以上のバージョンをインストールしてください。インストール手順については、[公式ドキュメント](https://docs.mongodb.com/v3.2/installation/)を参照してください。<br>
4. 認証データベースが正確であるか確認します。<br>
>!公式サイトのコンソールで作成したユーザーの認証データベースがすべてadminです。そのため、ユーザーがログインするときに認証データベースをadminに設定する必要があります。コマンドラインで作成したユーザーがログインするときには、そのコマンドラインに設定してください（例えば、testデータベースで作成したユーザーがログインするときに認証データベースをtestに設定）。


