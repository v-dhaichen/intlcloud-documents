Redis クラスタ版（コミュニティ）は、Tencent Cloud がコミュニティ版 Redis 4.0 に基づいて開発した新たなバージョンです。分散アーキテクチャを採用し、水平・垂直の容量拡張をサポートしています。高度な柔軟性と可用性、数千万レベルもの QPS という高いパフォーマンスを備えています。  Redis クラスタ版は水平方向に3シャード ～ 128シャード拡張でき、垂直方向に1 ～ 5 Replica Set 拡張できます。容量の拡張、縮小、移行プロセスにおいてサービスはほぼ感知せず、システムの可用性を最大限にします。![](https://main.qcloudimg.com/raw/28b67a0b4de50e751fd2119876019ffd.svg)

## クラスタ仕様
- シャード仕様（GB）：4、8、12、16、20、24、28、32
- シャード数量：3、5、8、12、16、24、32、64、96、128 
- コピー数量：1、2、3、4、5 

## クラスタモード
- Redis クラスタモードのデータは自動で断片化され、システムはデータバランスとデータ移行機能を提供します。
- クラスタモードがサポートするシャード仕様は4GB ～ 32GBです。
- クラスタモードのコマンドは、相対的にそれ以外のモードとある程度互換性があり、主に Slot を跨いだデータアクセスを反映します。詳細については [使用制限](https://cloud.tencent.com/document/product/239/18336?!preview&!editLang=zh#.E4.BD.BF.E7.94.A8.E9.99.90.E5.88.B6)をご参照ください。

## コピーについて
- コピー数が1である場合、Redis はデータマスタースレーブのリアルタイムホットバックアップを提供し、データには高度な信頼性と可用性があります。HA システムはノードの故障を検出すると、スレーブノードへの切り替えを要求し、新たにスレーブノードをシステムに追加します。
- コピーが1より大きい場合、Redis はデータマスタースレーブのリアルタイムホットバックアップを提供し、ノードからの読み取り専用機能を提供します。

## 機能の特性
**柔軟性** 
Redis クラスタ版は、3～128ノード水平方向に容量を拡張および縮小でき、1～5 Replica Set 垂直方向に容量を拡張および縮小できます。インスタンスを調整することで、さまざまなシナリオに対応します。
**可用性** 
Redis クラスタ版の水平方向（シャード数）と垂直方向（Replica Set 数）の容量拡張、縮小においてサービスは全く感知しないため、システムの可用性が高くなります。
 **互換性**
Redis クラスタ版はシナリオの中で、コミュニティ版のネイティブ Cluster の使用シナリオをサポートしています。Jedis などのスマートクライアントや、Codis 使用シナリオと互換性があります。
 **維持管理のしやすさ**
Redis クラスタ版はシステムの能力を最大限に生かします。シャードレベルの監視と管理、シャードデータの移行とバランス、そして親 Key 監視、ホット Key 監視などの高度な機能を提供することで、システムを完全に管理し、維持することができるのです。

## 適したシナリオ
**マスタースレーブの可用性の高いシナリオ**
1つのノードを選択してそのノード用に Replica Set を選択することで、マスタースレーブは高い可用性を発揮します。デュアルシステムホットバックアップと、故障の際に自動で切り替える能力を提供し、Redis サービスの高い信頼性と可用性を保証します。
 **Read/Write Splitting のシナリオ**  
ノードのコピーが1より大きい場合、TencentDB for Redis は自動で Read/Write Splitting 能力を提供します。垂直方向にシングルノード読み取り性能を拡張し、最大で5つの Replica Set をサポートします。また、マスターノードを配置し、各コピーノードの読み取りアクセスの重みづけをサポートします。 
**複数シャードの高パフォーマンスシナリオ**
Redis クラスタ版は自動でシャードモードを起動します。異なる Key を複数のノードに割り当てることで、水平方向にシステムのパフォーマンスを拡張することができます。

## 使用制限
クラスタ版データは、自動で Hash シャーディングされます。クラスタモードでは当面、4GBより少ない仕様を提供しません。
クラスタモードでは、Redis のコマンドのサポート状況は、**サポート**、**限定的にサポート**、**カスタムコマンド**、**サポートなし**に分けられます。サポートしていないコマンドには、以下のエラーメッセージが戻ります。
```
 select 1
 (error) ERR unknown command 'select'
```

**サポートしていないコマンド**
クラスタ版は複数の DB をサポートしていませんが、`select 0`コマンドをサポートしています。そのため、パフォーマンスにマイナスの影響がある可能性があります。専用データベースを使用することをお勧めします。そのため、以下のコマンドはブロックされ、実行するとエラーが発生します。
-  MOVE
-  SWAPDB
    
データの永続化とバックアップはコンソールで管理できるため、以下の関連コマンドはサポートしていません。
- BGREWRITEAOF
- BGSAVE
- LASTSAVE
    
システムの複製と高可用性はTencentDB for Redis のバックグラウンドで統一管理します。そのため、この操作については安定性のリスクをもたらす可能性があり、以下のコマンドはサポートしていません。
- REPLCONF
- SLAVEOF
- SYNC / PSYNC

クラスタ版は当面、トランザクション関連のコマンドをサポートしません。関連コマンドには以下が含まれます。
- MULTI
- EXEC
- DISCARD
- UNWATCH

その他サポートしないコマンド
- DEBUG 
- PFDEBUG
- OBJECT
- SHUTDOWN
- MONITOR
- COMMAND
- SCRIPT-DEBUG
- LATENCY
- READONLy
- TIME
- WAIT
- MODULE
- DBSIZE

**限定的にサポートするコマンド**
Jedis cluster の使用シナリオと互換性を持たせるため、TencentDB for Redis は、Cluster をサポートするコマンドを IP リストに返して変更し、戻す情報内の各ノードの IP アドレスはインスタンスの VIP になります。
- CLUSTER NODES
- CLUSTER SLOTS 
- CONFIG GET

Slot を跨いだコマンドサポート
クラスタ版は現在、以下のSlot を跨いだアクセスのコマンドをサポートしています。
- MGET
- MSET

現在、Slot を跨いで実行するコマンドをサポートしていません。システムは以下のエラーメッセージを返します。
 `(error) CROSSSLOT Keys in request don't hash to the same slot`
 
以下のSlot を跨いだアクセスのコマンドをサポートしていません。
- DEL
- UNLINK
- EXISTS
- BRPOP
- BLPOP
- SINTER
- STNTERSTORE
- SUNION
- SDIFF
- SDIFFSTORE
- MSETNX
- PFCOUNT
- PFMERGE
     
**カスタムコマンド：**
Redis クラスタ版では、VIP パッケージを通してクラスタモードでスタンドアロン版の体験利用を行いました。サービスの利便性を大きく向上させましたが、維持管理の透明性が不十分であるため、カスタムコマンドでこの欠点を補い、クラスタ内の各ノードへのアクセスをサポートします。サポート形式は、既存のコマンドのパラメータリストの右端に1つのパラメータ【ノードID】を追加し、COMMAND arg1 arg2 ... [ノードID]とします。ノード ID は`cluster nodes`コマンドを通じて、またはコンソールから取得できます。
  ```
	10.1.1.1:2000> cluster nodes
	25b21f1836026bd49c52b2d10e09fbf8c6aa1fdc 10.0.0.15:6379@11896 slave 36034e645951464098f40d339386e9d51a9d7e77 0 1531471918205 1 connected
	da6041781b5d7fe21404811d430cdffea2bf84de 10.0.0.15:6379@11170 master - 0 1531471916000 2 connected 10923-16383
	36034e645951464098f40d339386e9d51a9d7e77 10.0.0.15:6379@11541 myself,master - 0 1531471915000 1 connected 0-5460
	53f552fd8e43112ae68b10dada69d3af77c33649 10.0.0.15:6379@11681 slave da6041781b5d7fe21404811d430cdffea2bf84de 0 1531471917204 3 connected
	18090a0e57cf359f9f8c8c516aa62a811c0f0f0a 10.0.0.15:6379@11428 slave ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171 0 1531471917000 2 connected
	ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171 10.0.0.15:6379@11324 master - 0 1531471916204 0 connected 5461-10922

	ネイティブコマンド：
	info server
	カスタムコマンド：
	info server ef3cf5e20e1a7cf5f9cc259ed488c82c4aa17171
	
	SCAN コマンド例：
	scan 0 238b45926a528c85f40ae89d6779c802eaa394a2
	scan 0 match a* 238b45926a528c85f40ae89d6779c802eaa394a2
	
	KEYS コマンド例：
	keys a* 238b45926a528c85f40ae89d6779c802eaa394a2
  ```
  
 カスタムコマンドリスト：
- INFO	 
- MEMORY
- SLOWLOG
- KEYS （hashtag 対応、hashtag とのマッチングを優先）
- SCAN （hashtag 対応、hashtag とのマッチングを優先）

**サポートするコマンド**：
  Redis クラスタ版は、上記のコマンド以外のコマンドも全てサポートしています。

