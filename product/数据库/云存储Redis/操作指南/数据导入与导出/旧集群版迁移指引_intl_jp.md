##　操作シナリオ

TencentDB for Redis の旧クラスタ版（2018年1月1日以前に購入したクラスタ）はバージョンとアーキテクチャが古く、一定程度の安定性のリスクがあります。サービスの安定性を保つため、新しい Redis クラスタ版に移行することをお勧めします。
新しいバージョンでは、よりフレキシブルな仕様構成や高いパフォーマンス、そして完全な機能を体験できます。2018年10月15日～2019年1月30日まで、Redis 旧クラスタ版インスタンスから Redis 2.8 マスタースレーブ版または 4.0 クラスタ版にアップグレードするためのお手伝いをいたします。2.8 マスタースレーブ版については [Redis マスタースレーブ版](https://cloud.tencent.com/document/product/239/17950)を、4.0 クラスタ版については [Redis クラスタ版](https://cloud.tencent.com/document/product/239/18336)を参照してください。
>!Redis 旧クラスタ版インスタンスは、マスタースレーブ版またはクラスタ版にライブマイグレーションを行うことはできません。移行プロセスでデータを損失することのないように、移行開始時から Redis クラスタへの書き込みを停止する必要があります。
セキュリティグループを設定してサービスへのアクセスを禁止する方法や、パスワードを新しいパスワードに変更する方法により、サービスの書き込みをできなくすることが可能です。監視ページから、QPS が0になったかどうか確認できます。

## 前提条件
- 既に新たなマスタースレーブ版またはクラスタ版インスタンスを購入済みであること。
>? データが12GB未満で、後続のデータ増加が60GBを超えず、QPS が4Wを超えない場合は、Redis 2.8 マスタースレーブ版の使用をお勧めします。それ以外の場合は Redis 4.0 クラスタ版の購入をお勧めします。Redis 4.0 クラスタ版は、**トランザクションコマンドには対応していません**（トランザクションコマンドへの対応が必要な場合，2.8 マスタースレーブ版を選択してください）。その他のコマンドは、全面的に Redis 旧クラスタ版と互換性があります。
Redis 2.8 マスタースレーブ版は掲載価格76元/GB/月、Redis 4.0 クラスタ版は掲載価格84元/GB/月です。実際の状況により選択できます。
- データのインポートに使用する CVM の準備が完了していて、CVM のディスク容量は現在のインスタンスのデータを保存するのに十分な量であること。
- データインポートツール crs-port をインストール済みであること。ツールの使用説明とダウンロードアドレスは、[ツールアドレス](https://cloud.tencent.com/document/product/239/33786)を参照してください。

## 操作手順
1. Redis 旧クラスタ版インスタンスへのサービスの書き込みを停止します。
2. Redis 旧クラスタ版インスタンスのバックアップデータを作成し、インスタンスのバックアップ完了を待ちます。バックアップにかかる時間はデータ量によって異なり、バックアップ完了後、RDB ファイルが作成されます。
![](https://main.qcloudimg.com/raw/c48d183c272730a8fa3240cfb77114c9.png)
3. データバックアップ完了後、バックアップリストから過去にバックアップしたファイルを確認できます。【エクスポート】をクリックすると RDB ファイルが作成され、RDBファイルが作成されると対応するダウンロードリンクが生成されます。ダウンロードリンクをクリックしてイントラネットアドレスを複製し、イントラネットの CVM からバックアップファイルをダウンロードします。**クロスアベイラビリティゾーンのダウンロードには対応していません**。
4. 新たに購入した Redis 2.8 マスタースレーブ版、または 4.0 クラスタ版のパスワードを初期化します。**新インスタンスのパスワードは、“インスタンスID:インスタンスパスワード”のパスワード形式に対応していません。クライアントのアクセスはパスワードが設定されている場合のみ可能です**。crs-port ツールを使用して、ダウンロードした RDB ファイルを新インスタンスにインポートします。
```
crs-port restore -n 16 -i /data/dump.rdb -t 192.168.0.1:6379 -A passwd
```
5. データのインポートが完了した後、コンソールからデータのインポートが成功したかどうかを確認します。インスタンス詳細ページの設定情報から、実際のメモリ使用量を確認できます。
6. 新インスタンスに移行を適用するには、**コード内の旧クラスタ版の IP を新インスタンスの IP に更新するだけです**。
