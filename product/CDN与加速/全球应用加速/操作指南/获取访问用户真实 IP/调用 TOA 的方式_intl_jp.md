リスニングソケットがスリーウェイハンドシェイクのACKパケットを受信すると、LinuxカーネルはSYN_REVC状態からTCP_ESTABLISHED状態に入ります。この時、カーネルはtcp_v4_syn_recv_sock関数を呼び出します。
Hook関数tcp_v4_syn_recv_sock_toaは最初に元のtcp_v4_syn_recv_sock関数を呼び出し、次にget_toa_data関数を呼び出してTCP OPTIONからTOA OPTIONを抽出し、それをsk_user_dataフィールドに保管します。

上記の呼び出しが完了した後、inet_getname_toa hook inet_getnameが呼び出され、ソースIPアドレスとポートを取得する際に、最初に元のinet_getnameを呼び出し、次にsk_user_dataが空かどうかを判断します。実IPとportを抽出するためのデータがある場合は、inet_getnameの戻り値を置き換えます。

サーバプログラムはユーザーモードでgetpeernameを呼び出し、返されたIPとportはクライアントの元のIPとportです。
