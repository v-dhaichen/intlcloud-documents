Tencent Cloudアプリケーション型CLBは強化型CLBで、従来型のCLBと比較してアプリケーション型CLBはより多くの機能とより強い性能をサポートしています。従来型の基本機能に加え、アプリケーション型CLBはユーザーによるドメイン名とURLに基づく転送規則の構成、リダイレクト（例：HTTPリクエストをHTTPSリクエストにリダイレクト）、SNIの複数の証明書のバインディングなどをサポートします。このドキュメントでは、Tencent Cloudアプリケーション型CLBの入門使用方法について案内します。

## 1. CVMの購入とRSの構築
CLBはトラフィックの転送のみを行い、リクエストを処理する能力はありません。従って、ユーザーのリクエストを処理するCVMインスタンスが必要です。まずCVMを購入して、RSを構築してください。
### 1.1 CVMの購入
CVMの[購入ページ](https://buy.cloud.tencent.com/cvm)で適切なモデルとイメージなどを選択し、CVMのパスワードを設定し、セキュリティグループを構成してください（ここではテストのために、まずすべてのポートを解放し、後に制限を加えることが可能）。また、CVMを購入する時、パブリックネットワークのトラフィックを開放するよう注意してください。開放しないと、後でCLBに関連付けしてもアクセスができません。
![](https://main.qcloudimg.com/raw/8edc105a8037a0bedcb2538828430d81.png)

この例では既に広州地域にCVMインスタンス`rs-1`と`rs-2`を作成しました。詳細については、[CVMインスタンスの購入と起動](https://cloud.tencent.com/document/product/213/4855)を参照してください。
- **CVM情報**
 - 地域：広州
 - Availability Zone：広州3区1台、広州4区1台
 - CVM課金モード：従量制課金
 - ネットワーク課金モード：帯域幅による課金
 - 所属ネットワーク：VPC（デフォルトのDefault-VPC）
- **マシン構成**
 - インスタンスタイプ：S4.SMALL2（標準型S4）
 - オペレーティングシステム	CentOS 7.5　64ビット
 - CPU：1コア
 - メモリ：2GB
 - システムディスク：50GB（一般クラウドディスク）
 - データディスク：500GB（Premium Cloud Storage）
 - パブリックネットワーク帯域幅：1Mbps（必須）

 > 注：現在の帯域幅の属性がCLBではなくCVMにあるため、CVMでパブリックネットワーク帯域幅を購入する必要があります。

### 1.2. RSの構築
本文ではHTTP転送を例として説明します。この場合、CVMで対応するWebサーバー（例：Apache、Nginx、IISなど）を配置する必要があります。結果を検証するため、例では`rs-1`上ににNginxを配置し「This is rs-1! URL is index.html」を含むHTMLを返し、`rs-2`上でNginxを配置し「This is rs-2! URL is image/index.html」を含むHTMLを返しました。Nginxの配置については、[Linux(CentOS)におけるNginxの配置](今後リリース予定)を参照してください。また、CVM上でサービスを配置する方法の詳細については、[Linux（CentOS）におけるJava Webの配置](今後リリース予定)及び[WindowsにおけるPHPのインストールと構成](https://cloud.tencent.com/document/product/213/10182)を参照してください。

### 1.3 サービスの検証
CVMのパブリックネットワークIP + パスにアクセスし、配置済みのページを表示することができる場合、サービスの配置が完了したことが証明されます。

## 2. CLBインスタンスの購入
1. Tencent Cloudの[CLBサービス購入ページ](https://buy.cloud.tencent.com/lb)にログインします。
2. この例では、地域はCVMと同じ【広州】、インスタンスのタイプは【アプリケーション型】、ネットワーク属性は【パブリックネットワーク】、ネットワークは【Default-VPC（デフォルト）】を選択し、インスタンス名称は【clb-test】と記入します。
3. 【すぐに購入】ボタンをクリックすると、支払いが完了します。
CLBインスタンスの詳細内容については、[購入属性のガイド](今後リリース予定)を参照してください。
![](https://main.qcloudimg.com/raw/ce5c1f23b671760a8e14f06f28040da4.png)
4. 【LBインスタンスリスト】ページで対応する地域を選択すると、新規作成したインスタンスが表示されます。
![](https://main.qcloudimg.com/raw/36e75ded1d8a0e93bd25b9c24ee850c5.png)

## 3. CLBリスナーの作成
CLBリスナーはプロトコル及びポートを指定することにより実際の転送を行います。本文はCLBクライアントのHTTPリクエスト転送の構成を例とします。
### 3.1 HTTPリスナー監視プロトコルとポートの構成
1. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、【クラウド製品】-【ネットワーク】-【CLB】をクリックしてCLBコンソールに進みます。
2. 【LBインスタンスリスト】で作成済みのアプリケーション型CLBインスタンス`clb-test`を見つけ、インスタンスIDをクリックしてCLBの詳細ページに進みます。
3. 【基本部分】で、名前の後の小さいアイコンをクリックしてインスタンス名を変更することができます。
4. 【リスナー管理】中の【HTTP/HTTPSリスナー】において、【新規作成】ボタンをクリックし、CLBリスナーを新規作成します。
![](https://main.qcloudimg.com/raw/08476cf9f61eec6dc1baba400821e6ec.png)
5. ポップアップウィンドウにおいて以下の内容を構成します。
  - 名称は「Listener1」にカスタマイズします。
  - 監視プロトコルのポートは`HTTP：80`です。
  - 【確定】ボタンをクリックして、CLBリスナーを作成します。

### 3.2 リスナーの転送規則の構成
1. 【リスナー管理】で先ほど新規作成したリスナーListener1を選択し、「+」記号をクリックすると、規則の追加が開始します。
![](https://main.qcloudimg.com/raw/ff0a2b40bf4fcd7e361966ee6d4a21d9.png)
2. ポップアップウィンドウでドメイン名、URLパスと分散方式を構成します。
  - ドメイン名：お客様のRSが使用しているドメイン名であり、この例では`www.qcloudtest.com`を使用します。ドメイン名にはワイルドカードが使用可能で、詳細については、[構成の説明](https://cloud.tencent.com/document/product/214/9032)をご参照ください。
  - URLパス：お客様のRSのアクセスパスであり、この例では`/image/`を使用します。
  - 分散方式は`重み付きラウンドロビン`を選択します。
![](https://main.qcloudimg.com/raw/1dc1ab66d04f361dd138e24eb7509d50.png)
3. 正常性検査の構成：正常性検査を有効にし、検査ドメイン名はデフォルトの転送ドメイン名と転送パスを使用します。
![](https://main.qcloudimg.com/raw/305f3f9de7e4641f0cd8f5944ff57ac8.png)
4. セッション保留：セッション保留にはチェックを入れません。
5. 【完了】をクリックすると、リスナー転送規則の構成が完了します。
![](https://main.qcloudimg.com/raw/5de81a61e3a83eb760339ed0124f7d66.png)

CLBリスナーの詳細内容については、[CLBリスナーの概要](https://cloud.tencent.com/document/product/214/6151)を参照してください。
> 注：1つのリスナー（すなわち監視プロトコル：ポート）に複数のドメイン名を構成することができ、1つのドメイン名の下に複数のURLパスを構成することができます。リスナーまたはドメイン名を選択し、「+」記号をクリックすると新しい規則を作成することができます。
> セッション保留：ユーザーがセッション保留機能をオフにし、ラウンドロビン方式を選択してスケジューリングを行った場合、リクエストはそれぞれのRSに順次割り当てられます。ユーザーがセッション保留機能をオンにし、またはセッション保留機能をオフにするがip_hashのスケジューリング方式を選択する場合、リクエストは引き続き同じRSに割り当てられます。

### 3.3 CVMのバインディング
1. 【リスナー管理】ページで先ほど作成したリスナーListener1を選択して展開し、ドメイン名を選択し、URLパスを選択すると、画面の右側にこのURLパスがバインディングしているCVMの情報が表示されるので、【バインディング】ボタンをクリックします。
![](https://main.qcloudimg.com/raw/fa041a80ebf420e75f77f4ab5fbddf24.png)
2. ポップアップウィンドウにおいてCLBと同じ地域にあるCVMインスタンス`rs-1`と`rs-2`を選択し、CVMのポートをいずれも`80`に、CVMの重み付けをいずれもデフォルト値`10`に設定します。
![](https://main.qcloudimg.com/raw/8729820affbf015a4256f8716ae888de.png)
3. 【確定】ボタンをクリックすると、バインディングが完了します。
4. リスナーからURLパスまでの次元を展開すると、バインディングされているCVMとその正常性検査のステータスを確認することができます。ステータスが「正常」の場合、CVMはCLBが転送したリクエストを正常に処理できることを示します。
![](https://main.qcloudimg.com/raw/b66d71a83253dd0729092a0489c33d1e.png)
> 注：1つの転送規則（監視プロトコル + ポート + ドメイン名 + URLパス）は同じCVMの複数のポートをバインディングすることができます。ユーザーが`rs-1`の`80`と`81`ポートに同じサービスを配置する場合、CLBは例における転送規則によって同時に`rs-1`の`80`と`81`ポートをバインディングすることをサポートします。2つのポートはいずれもCLB転送のリクエストを受信します。

## 4. CLBサービスの検証
CLBの構成が完了したら、当社でこのアーキテクチャが有効かどうか検証することができます。つまり、1つのCLBインスタンスの異なる**ドメイン名+URL**により異なるバックエンドCVMにアクセスすることを検証し、また、**「コンテンツベースルーティング（content-based routing）」**の機能を検証します。
### 4.1 方法1：hostsを構成し、ドメイン名をCLBに指向
Windowsシステムで`C:\Windows\System32\drivers\etc`ディレクトリに進み、hostsファイルを変更し、ドメイン名をCLBインスタンスのVIP上にマッピングします。
![](https://main.qcloudimg.com/raw/2a5cd0cc116ce53fed3ac98d4017a59f.png)

hostsの構成が完了したかどうかを検証するため、このマシンでcmdを開きpingコマンドでこのドメイン名がVIPをバインディングできたかどうかを検出します。データパケットが見つけたら、バインディングが正常に行いました。
![](https://main.qcloudimg.com/raw/cbf250997c885695d3ff8525de816be5.png)

次に、ブラウザにアクセスパス`http://www.qcloudtest.com/image/`を入力して、CLBサービスをテストします。以下では今回のリクエストがCLBによりrs-1のCVMに転送され、CVMがリクエストを正常に処理し返すことを示します。
![](https://main.qcloudimg.com/raw/97b1f947d2b9dd90e99efb82a95722b9.png)

このリスナーのラウンドロビンアルゴリズムは「重み付きラウンドロビン」であり、2台のCVMの重み付けはいずれも10です。ブラウザをリフレッシュして再度リクエストを送信すると、今回のリクエストがCLBによりrs-2のCVMに転送されていることが分かります。
![](https://main.qcloudimg.com/raw/7c467013c2635338527dc0eb70fc4635.png)
> 注：`image/`の後の`/`は、これはimageという名前のファイルでなく、デフォルトのディレクトリであることを表すので、非常に重要です。

### 4.2 方法2：クラウド解析を構成し、ドメイン名をCLBに指向
1. [Tencent Cloudドメイン名登録ページ](https://dnspod.cloud.tencent.com)を開いてドメインの照合と登録を行います。この例はqcloudtest.comを例としており、詳細については、[ドメイン名の登録](https://cloud.tencent.com/document/product/242/9595)を参照してください。
2. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、【クラウド製品】-【ドメイン名とWebサイト】-【クラウド解析】をクリックします。
3. 購入した【ドメイン名】をクリックし、【ドメイン名分析管理】のページで【記録の追加】ボタンをクリックし、ドメイン名にA記録を追加し、以下の内容を入力します。
  - 記録タイプ：`A記録`。
  - CVMの記録：すなわちドメイン名のプレフィックス。この例はすべてのプレフィックスの解析を例として、`*.qcloudtest.com`に設定します。
  - 回線タイプ：デフォルト。
  - 記録値：【クラウドリソースの関連付け】をクリックして、ポップアップウィンドウで作成したばかりの`clb-test`を選択します。
  - TTL：デフォルト値`600s`に設定します。
  - 追加が完了後、【保存】をクリックします。

クラウド解析がこの記録をInternet上で広めるにはしばらく時間がかかります。ドメイン名が正常に解析されているかどうかをテストするため、解析記録を追加した後しばらく経ってから、バインディングされたCNAMEドメイン名（例：この例では、www.qcloudtest.com）に直接アクセスすることによりCLBを検証することができます。

## 5. リダイレクト機能の構成（オプション）
リダイレクトの構成は、手動リダイレクトと自動リダイレクトの2種類に分かれます。
- 自動リダイレクト（HTTPSに強制）：PC、携帯電話のブラウザなどはHTTPリクエストでWebサービスにアクセスし、CLBプロキシを通じてHTTPSのrespondを返すことが望ましい。デフォルトではブラウザはHTTPSでWebサイトにアクセスするよう強制されています。
- カスタムリダイレクト：Webサービスを一時的に無効化する必要がある場合（例：電子商取引での完売、ページの保護、アップデートやアップグレードの時）にリダイレクト能力が必要です。リダイレクトしない場合、お気に入りと検索エンジンデータベースの中の古いアドレスによりアクセスしたユーザーには404/503のエラー情報ページのみが表示され、ユーザー体験が低下し、アクセストラフィックが無駄に失われることになります。これだけでなく、以前、このページに蓄積された検索エンジンのスコアも無駄になります。
詳細については、[リダイレクトの構成](https://cloud.tencent.com/document/product/214/8839)を参照してください。

