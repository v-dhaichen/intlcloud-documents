## 기본 레이어 실현
Tencent Cloud CLB는 현재 4계층과와 7계층의 CLB 서비스를 제공하며 Tencent가 발기한 Tencent gateway(TGW)에 기반하고 게이트웨이 제품이 제공하는 로드밸런싱 능력을 통일하기 때문에 높은 신뢰성, 강력한 확장성, 고성능, 강한 공격 저항 능력 등을 보유하고 있습니다. 대규모 동시 발생 접근을 실현할 수 있고 악의적인 공격 트래픽을 방지합니다. CLB 제품 기능은 로드밸런싱 능력, 공인 IP 수렴, Anti-DDoS, QoS, FTP, SIP지원 등 능력을 포함합니다.
CLB는 클러스터 배포를 통해 세션 동기화를 실현하여 서버 단일 장애점을 제거함으로써 여분을 증가시키는 동시에 서비스의 안정성을 보장합니다. 동일 지역에 여러 개의 IDC를 배포하여 지역 내 재해 복구를 실현할 수 있습니다.
다음은 플랫폼, 리소스, 비즈니스 차원에서 CLB가 클라우드 플랫폼 테넌트 격리, 아키텍처 재해 복구, 리소스 재해 복구, 공격 방어 등 기능의 핵심 기술 원리를 소개하고 있습니다.
>?
>- RS란 CLB 로드밸런서를 바인딩한 CVM을 가리킵니다.
>- VIP란 CLB 로드밸런서 대외 서비스의 IP 주소를 가리킵니다.

### 테넌트 격리
클라우드 플랫폼의 핵심 능력은 바로 테넌트 격리입니다. 클라우드에 액세스한 사용자는 모두 자신의 비즈니스가 타인의 영향을 받지 않고 적어도 네트워크에서 격리를 실현하여 서버가 랜덤으로 접근되지 않길 기대합니다. 자주 사용하는 방법은 하드웨어에서 격리하는 방법이며, 특정 액세스 교환기와 vxlan 프로토콜을 사용하여 격리 목적을 달성합니다. 단, 이 방법은 다음과 같은 단점이 존재합니다.
- 특수한 교환기를 사용해야 합니다.
- 별도 설정으로 vxlan 네트워크와 일반 네트워크를 연결하면 SSO 문제가 존재하게 됩니다.
- 현재 네트워크 환경과 호환하기 어렵습니다.

위와 같은 이유로 인해 CLB는 소프트웨어 방안을 선택해 IP 터널 + VPC의 조화로 테넌트 격리를 실현합니다.
![](//mccdn.qcloud.com/static/img/cf8f46731a218bf7fef43843eef0d4e4/image.png)
위 그림 왼쪽을 볼 수 있듯이 CLB와 RS가 IP 터널 방식로 상호적용하며 CVM(RS)이 할당한 실제 사설 IP와 물리적 네트워크는 연결됩니다. 이 방법은 실현하기 간단하며 이전의 물리적 서버 방안과 호환할 수 있지만 다음과 같은 단점이 존재합니다.
- 별도의 모듈로 테넌트 간의 격리를 실현해야 합니다.
- 테넌트 간의 사설 IP는 재이용할 수 없으며 자유 네트워킹을 실현할 수 있습니다.
- IP는 사설망에서 유일하기 때문에 마이그레이션할 때 RS의 IP를 변환해야 하야 핫 마이그레이션을 실현할 수 없습니다.

위와 같은 이유로 인해 Tencent Cloud는 VPC를 개발하였습니다. 위 그림 오른쪽에서 볼 수 있듯이 동일 테넌트가 하나의 VPCID에 할당될 경우, VPC 내에서 클라이언트는 자유롭게 네트워킹할 수 있으며 테넌트 네트워크 자체는 격리됩니다. 구체적인 처리는 vpc.ko 커널 모듈을 통해 구현합니다.

### IP 컨버전스
CLB를 이야기하면 LVS(Linux Virtual Server) 기술을 빠질 수 없습니다. LVS는 다음 모드가 있습니다.
- DR 모드: 주요 단점은 LVS와 RS가 반드시 동일 vlan에 있어야 하기 때문에 배포 한도가 크고 확장 가능성은 떨어집니다.
- NAT 모드: 주요 단점은 RS의 데이터 패킷 반환은 기본적인 라우팅을 사용해야 하기 때문에 확장성 문제가 존재합니다. 따라서 처음으로 LVS 클러스터를 구축할 때 TUNNEL 모드를 사용합니다.
- TUNNEL 모드: 각 RS에 공인 IP를 할당해야 합니다. Tencent Cloud 및 RS가 비교적 많은 비즈니스의 경우, 공인 IP는 아주 큰 도전입니다.

위와 같은 이유로 Tencent Cloud는 CLB를 개발하였습니다. 아래 그림은 LVS 방안과 CLB 방안의 인스턴스 약도이며 두 가지의 주요 차이점은 다음과 같습니다.
- CLB는 RS에 공인 IP를 할당할 필요없이 IP 컨버전스를 실현합니다.
- 아웃바운드 트래픽은 여전히 CLB를 통과합니다. 문제를 쉽게 찾아낼 수 있으며 서비스 트래픽에 대해 폐쇄 루프가 형성되어 브리지 헤드의 역할을 담당합니다.
![](//mccdn.qcloud.com/static/img/e4575f5f414666505d8c1a7cdea2c6f0/image.png)

### 높은 신뢰성 실현
높은 신뢰성은 클라우드 서비스를 평가하는 중요한 메트릭입니다. CLB는 다음 방안을 실현할 수 있기 때문에 신뢰성 높은 서비스를 제공합니다.
- [클러스터 재해 복구](#jqrz)
- [세션 동기화](#jqrz)
- [리소스 격리](#zygl)
- [DDos 공격 방어](#kgj)

<span id="jqrz"></span>
#### 클러스터 재해 복구와 세션 동기화
클러스터 재해 복구란 하나의 클러스터에 한 대의 서버가 다운되어도 전체 클러스터에 영향을 미치지 않는 서비스 능력을 가리킵니다. 전통적인 클러스터 재해 복구는 HA 모드(vrrp 프로토콜)를 선택하며 일반적인 소스 오픈 방안(예: LVS)의 단점은 다음과 같습니다.
- 클러스터당 절반 서버만 동시에 작업할 수 있으며, 나머지 절반은 콜드 백업 상태입니다.
- 다운 후의 전환 속도가 비교적으로 느린 편입니다.

CLB는 ospf 동적 라우팅 프로토콜로 클라우드 재해 복구를 실현합니다. 서버 하나가 고장나면, ospf 프로토콜은 10s 이내에 서버를 클러스터에서 제거할 수 있습니다. CLB는 하나의 클러스터를 두 개의 액세스 스위치 아래에 놓고 크로스 랙 재해 복구를 보장하므로 단일 랙의 단일 스위치 고장 또는 정전으로 인한 장애가 클러스터 서비스에 영향을 미치지 않습니다.
클러스터 재해 복구는 CLB 클러스터의 가용성을 보장하지만 클라이언트의 입장에서 서버가 다운되는 경우 해당 서버를 제거하면 새로운 연결이 이 시스템으로 이동하지 않을 것입니다. 이러한 문제를 해결하기 위해 당사는 클러스터 내 세션 연결 정기적 동기화를 실현하여 다른 서버에서 고장 서버의 패킷을 접수할 때, 세션을 정확히 찾아내고 정장적으로 서비스 실행을 보장합니다.
![](//mccdn.qcloud.com/static/img/4cdd6084a39561e04539a8866374bb24/image.png)
종합해 보면:
- LVS: 연결 상태 변화 시 동기화합니다. 다양한 길이의 연결이 공존하는 상황에서 짧은 연결을 선택한 비즈니스의 동기화 트래픽은 매우 크기 때문에 정상적인 포워딩에 충격을 줄 수 있습니다.
- CLB: 연결이 생성된 5초 후에야 동기화되며, 연결이 5초 이내일 경우 동기화되지 않고 긴 연결만 동기화합니다.
![](//mccdn.qcloud.com/static/img/397479668381a345c8bae877e4aa4ff3/image.png)

<span id="zygl"></span>
#### 리소스 격리
리소스 격리는 개별 비즈니스가 공격을 받고 CLB에 고부하 문제가 발생했을 때, 기타 비즈니스에 영향을 받지 않도록 보장합니다. 구체적인 실현 방법은 다음과 같습니다.
- CLB가 고부하 경고선에 도달했는지 정기적으로(5초) 확인하여 도달하는 경우, 리소스가 격리됩니다.
- CLB가 모든 비즈니스의 트래픽, 패킷, 연결 수를 검사하며 한도를 초과하면 버릴 것입니다. CLB 서버가 고부하 상태에 다다라 다른 비즈니스에 영향을 끼치는 일이 발생하지 않도록 도와줍니다.
- 정상적인 상황에서 리소스 격리 기능은 꺼져 있습니다. 비즈니스량이 급증하거나 어느 비즈니스가 공격을 받아서 CLB가 경계선에 다다를 경우, 5s 내에 해당 기능을 활성화하여 비즈니스 포워딩의 정상적인 실행을 보장합니다.
- 리소스 격리는 전형적인 토큰 버킷 알고리즘을 사용하여 작업 과정은 다음과 같습니다. 정기적으로 버킷에 일정량의 토큰을 놓으며 패킷을 이룰 때마다 토큰 하나를 소모하고 일정 기간 내 토큰이 모두 소모되면 패킷을 버립니다.
![](//mccdn.qcloud.com/static/img/86cd36ef04f3200b8d0c591b0c4e7675/image.png)

<span id="kgj"></span>
#### Anti DDos
클러스터 재해 복구와 리소스 격리는 모두 CLB 플랫폼 자체를 보호하고 단일 비즈니스가 공격받았을 경우, 부상 입을 확률은 100%이며 CLB는 이러한 상황이 발생하는 것을 허가하지 않습니다. DDos 공격에 대해 Tencent Cloud는 전문적인 [Anti DDos](https://cloud.tencent.com/product/ddos)를 통해 비즈니스를 보호합니다. 그러나, 점검 기간은 10초이고 이는 Anti DDos가 시행되기 전에 클라이언트의 RS가 이미 손상될 수 있음을 의미합니다. 이 10초 내에 문제를 해결하기 위해 synproxy 기능을 개발했습니다. 구체적인 방법은 다음과 같습니다.
- CLB는 클라이언트의 3방향 핸드 셰이크 요청을 수신하였을 때, 3방향 핸드 셰이크를 프록시하여 데이터 패킷이 도착하기 전까지 RS를 방해하지 않습니다.
- 첫 번째 패킷이 도착했을 때 CLB는 그를 캐시한 다음 RS와 3방향 핸드 셰이크를 진행합니다.
- 핸드 셰이크가 성공한 후에, 캐시한 데이터 패킷을 RS에 발송하고 이후의 과정은 데이터 패킷을 패스 스루합니다.

이렇게하면 DDos 공격이 RS에 전달되지 않고 CLB는 대신 압력을 처리할 것입니다. CLB 자체는 상대적으로 강한 부하 용량과 클러스터 모드 및 리소스 분리 기능을 갖추고 있기 때문에 정상적인 상황에서 10초 이내에 CLB 서버를 파괴시키는 것은 어렵습니다.
![](//mccdn.qcloud.com/static/img/5c96f1c2548dd15bd00d0ff01b63eddf/image.png)

## Tencent Cloud CLB 특징
Tencent Cloud CLB는 현재 4계층과 7계층 프로토콜로 포워딩하는 능력을 제공합니다.
- 4계층 CLB는 수신기의 TCP와 UDP에 해당합니다.
- 7계층 CLB는 수신기의 HTTP/HTTPS 능력에 해당합니다.

### 4계층 CLB
4계층 CLB는 CLB가 최초적으로 실현하는 방안이자 CLB 제품이 반드시 갖춰야 할 기능입니다. 기본 원리는 CLB에서 포트로 다른 비즈니스를 구분하며, 포워딩 규칙의 키는 vip:vport:protocol입니다. 현재 Tencent Cloud에 가장 많이 사용하는 방식은 이러한 로드밸런싱 방식이지만 Tencent Cloud 중 VIP는 동일한 개발사에 속하며 다른 개발사 간의 트래픽은 엄격히 격리됩니다.
![](//mccdn.qcloud.com/static/img/bb969f908e3931c61267c316e6e4f909/image.png)

### 7계층 CLB
일일 임대료가 없는 솔루션은 일반적인 7계층 CLB 서비스를 처리할 수 있지만 세션 및 쿠키가 필요한 7계층 사용자의 경우 역방향 프록시를 수행하기 위해 스스로 nginx를 구축해야 하므로 리소스 낭비와 안정성 저하를 초래할 수 있습니다.
![](//mccdn.qcloud.com/static/img/6d385cd8c23ca392c36540eff8689e5c/image.png)
이러한 상황을 기반으로 하여 7계층 CLB는 두 가지 실현 방안을 준비하였습니다.
- 방안1: 공인 IP를 nginx 서버에서 적용괴고 nginx 클러스터를 구축합니다.
- 방안2: nginx 클러스터를 4계층 CLB에 연결합니다.

방안1의 단점은 DDos 공격에 완전히 취약하다는 것입니다. Tencent Cloud에는 4계층과 7계층으로 동시에 액세스할 VIP가 필요하기 때문에 CLB는 방안2를 채택하였습니다. 그 밖에 방안2는 동적으로 용량 확장/줄임이 편리하기 때문에 비즈니스를 빠르게 확장해야 할 시나리오에 적합합니다.
하지만 nginx 자체는 역방향 프록시를 통해 CLB를 실현하며, Tencent Cloud에 존재하는 문제는 다음과 같습니다. VPC 네트워크는 가상 네트워크이기 때문에 물리적 네트워크 간에 호스트를 통해 연결합니다. 7계층 CLB와 RS 간에는 nginx의 역방향 프록시 기능을 직접적으로 사용할 수 없기 때문에 당사는 7계층 CLB에 l7.ko 커널 모듈을 삽입하여 gre 터널과 IP 터널 및 RS 간의 상호 작용을 캡슐화하는 데에 사용됩니다.
![](//mccdn.qcloud.com/static/img/9874ed32509218619ef4cea119bc3790/image.png)

