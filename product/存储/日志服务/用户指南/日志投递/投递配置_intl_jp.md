## 概要
CLSはCOSへのログ配信をサポートしているため、ログデータを永続的に保存できます。配信間隔、ファイルサイズ、配信パスおよびフィルタリング規則に基づいてログをCOSに配信できるように、コンソールで構成を行うだけです。 

## 使用手順
### 前提条件

1.CLSを有効にし、ログセットとログトピックを作成すると、ログデータを正常に収集できます。  
2.Tencent Cloud COSを有効にして、配信タスクが属するログセットの領域にバケットを作成します。  
3.現在のアカウントに配信を構成する権限があることを確認してください。サブアカウント/協力者の配信許可の詳細については、[サブアカウント配信の構成](https://cloud.tencent.com/document/product/614/33098)を参照してください。

### 設定手順
1.[CLSコンソール](https://console.cloud.tencent.com/cls)にログインしてください。  
2.左側のナビゲーションバーで【ログセット管理】をクリックします。  
3.配信タスクを設定する必要があるログセットID/名称をクリックして、ログセットの詳細ページに進みます。
![](https://main.qcloudimg.com/raw/b4560b57c179e20441fa56bd65803971.png)
4.配信するログトピックを見つけ、【構成管理】>【COS構成の配信】をクリックして、構成の配信ページに進みます。
![](https://main.qcloudimg.com/raw/df645d270b696a380253435e079a8949.png)
5.【構成配信の追加】をクリックし、**COSへの配信**構成ページに進み、構成情報を順番に入力して【次へ】をクリックします。構成項目の詳細については、[構成項目の説明](#config)を参照してください。
![](https://main.qcloudimg.com/raw/c588bcb6e91bb9849003532968edac44.png)
6.高度な構成に進み、配信フォーマット、圧縮配信、圧縮フォーマットおよび配信フィルタリングを選択します。
json配信フォーマットを選択した場合は、以下の構成を行う必要があります。
![](https://main.qcloudimg.com/raw/3711401cfd70d3f583bb82dae1970331.png)
csv配信フォーマットを選択した場合は、keyのコンテンツ、区切り文字、エスケープ文字、無効なフィールドコンテンツ、最初の行に書き込むかどうかなどを指定する必要があります。
![](https://main.qcloudimg.com/raw/a83f64cd3434e7fd894249e4dea0eb10.png)
 - key：csvファイルに書き込むkeyフィールドです。
 - 区切り文字：csvファイル内の各フィールド間の区切り文字です。
 - エスケープ文字：通常のフィールドに区切り文字がある場合、エスケープ文字でこの文字を囲む必要があります。
 - 無効なフィールドコンテンツ：構成したcsvキー値フィールドが無効なkeyである場合、無効なフィールドで埋められます。
 -  1行目のKeyの書き込み：キー値名（key）の最初の行をcsvファイルに書き込みます。デフォルトでは書き込みません
7.配信ステータスが有効になっているかどうかを確認します。
![](https://main.qcloudimg.com/raw/14e70eec382e5dab3803a71752ffd62c.png)

<a id="config"></a>
### 構成項目の説明
#### ディレクトリプレフィックス（オプション）
CLSはカスタムディレクトリプレフィックスをサポートし、ログファイルはCOS Bucketのこのディレクトリに配信されます。デフォルトではバケットの直下に配置されます。ファイルパスは `{COSバケット}{ディレクトリプレフィックス}{パーティションフォーマット}_{random}_{index}.{type}` です。そのうち`{random}_{index}`は乱数です。

#### パーティションフォーマット（必須）
配信タスクの作成時間はstrftimeの構文に従ってディレクトリが自動的に生成されます。スラッシュ`/`は第1レベルのCOSディレクトリを表します。bucket_testバケットに配信するためのディレクトリプレフィックスは`logset/`で、配信時間は2018/7/31 17:14です。

| バケット名  | ディレクトリプレフィックス | パーティションフォーマット    | COSファイルのパス                                       |
| ----------- | -------- | ----------- | ------------------------------------------------- |
| bucket_test | logset/ | %Y/%m/%d    | bucket\_test:logset/2018/7/31\_{random}\_{index}    |
| bucket_test | logset/ | %Y%m%d/%H  | bucket\_test:logset/20180731/14\_{random}\_{index} |
| bucket_test | logset/ | %Y%m%d/log | bucket\_test:logset/20180731/log\_{random}\_{index} |

#### 配信用ログを圧縮する（オプション）
ユーザーが圧縮後にログファイルを配信するかどうかを選択できます。配信時の非圧縮ファイルの最大サイズは10GBです。現在サポートされている圧縮方法はgzipとlzopです。

#### 配信ファイルサイズ（必須）
これは、配信間隔内に**非圧縮の配信ファイル**の最大サイズを指定します。この時間間隔でログファイルは設定した値以下になり、上限を超えると複数のログファイルに分割されます。サポートされている最大サイズは**100MBから10GB**です。 

#### 配信時間間隔（必須）
配信の時間間隔を指定します。**1分から1時間までサポート**。配信間隔を5分に設定したとすると、ログデータは5分ごとに一つのログファイルを生成し、定期的に（30分以内）複数のログファイルがまとめてバケットに配信されます。 


#### 詳細オプション（オプション）
ログ配信では、ログコンテンツに基づいて配信フィルタリングすることもできます。ログコンテンツは詳細オプションを開くことで構成することができます。keyを指定し、そのキー値に対応する値に対して通常の抽出を実行し、抽出された部分が一致するために必要な値を設定できます。このログは、ログデータが構成と一致する場合にのみ配信できます。一致するログは配信されません。次の図に示すように、actionフィールドを指定すると、そのフィールドが書き込みのときにログが配信されます。配信フィルタリング規則は最大5つをサポートします。 
![](https://main.qcloudimg.com/raw/fa774d5a865c2129f707465c55e416c7.png)

>!単一行フルテキスト検索および複数行フルテキスト検索の場合、デフォルトのkey値は **\_CONTENT_** です。

