このチャプターでは、Tencent Cloud COSにおけるリクエストレートパフォーマンスの最適化のベストプラクティスについて説明します。

Tencent Cloud COSが提供する典型的な作業負荷能力は毎秒1000のPUTリクエスト、または毎秒2000のGETリクエストです。作業負荷が上記能力を超える場合、このガイドに従ってリクエストレートのパフォーマンス拡張および最適化を実現することをお勧めします。

>！リクエスト負荷とは、毎秒開始されるリクエストの数であり、同時接続の数ではありません。即ち、何千もの接続を維持しながら、1s内で何百もの新しい接続リクエストを送信できます。


Tencent Cloud COSは、より高いリクエストレートをサポートするためにパフォーマンス拡張をサポートします。リクエストが高いGETリクエスト負荷であれば、Tencent Cloud CDN製品と組み合わせて使用することをお勧めしますので、[CDNとCOSを組み合わせるベストプラクティス](https://cloud.tencent.com/document/product/436/8467)を参照してください。バケットの包括的なリクエストレートが毎秒2000のPUT/LIST/DELETEリクエストを超えると推定される場合、作業負荷の準備を整え、リクエストの制限に遭遇しないように、 [お問い合わせ](https://cloud.tencent.com/document/product/282/1558)をお勧めします。

>！ハイブリッドリクエスト負荷がたまに毎秒1200に達し、かつバーストで毎秒2000を超えない場合、このガイドに従う必要はありません。

## ハイブリッドリクエスト負荷

多数のオブジェクトをアップロードする必要がある場合、選択したオブジェクトキーによりパフォーマンスの問題が発生する可能性があります。以下、Tencent Cloud COSでのオブジェクトキー値の記憶方法について説明します。

Tencent Cloudは、COSの各サービス地域にバケット（Bucket）およびオブジェクト（Object）のキー値をインデックスとして保持し、オブジェクトキーはインデックスの複数のパーティションにUTF-8バイナリ順で保存されます。多数のキー値に対して、例えば、タイムスタンプまたはアルファベット順を使用すればキー値が位置するパーティションの読み書きパフォーマンスが使い果たされる可能性があり、バケットパス`testbucket-123454321.cos.ap-beijing.myqcloud.com`を例とし、インデックスのパフォーマンスが使い果たされる可能性があるいくつかのケースを以下に挙げます：

```
20170701/log120000.tar.gz
20170701/log120500.tar.gz
20170701/log121000.tar.gz
20170701/log121500.tar.gz
...
image001/indexpage1.jpg
image002/indexpage2.jpg
image003/indexpage3.jpg
...
```

ビジネスの典型的な負荷が毎秒500のリクエストを超える場合、上記ケースにおける順のキー値の使用を回避するべきです。ビジネスがオブジェクトキーとして連番または日付などの文字を使用する必要がある場合、いくつかの方法でオブジェクトキー名称にランダムなプレフィックスを追加して、複数のインデックスパーティションでキー値管理を実現し、集中負荷のパフォーマンスを向上させることができます。以下、キー値にランダム性を高めるいくつかの方法を提供します。

以下に提供する方法はいずれも単一のバケットのアクセスパフォーマンスを向上させる可能性がある方法であり、ビジネスの典型的な負荷が毎秒500のリクエストを超える場合、以下の方法を実行すると同時に、ビジネス負荷の準備を事前に整えるために、 [お問い合わせ](https://cloud.tencent.com/document/product/282/1558)をお勧めします。**

### 16進数のハッシュプレフィックスの追加

オブジェクトキーのランダム性を高める最も直接的な方式は、オブジェクトキー名称の先頭にプレフィックスとしてハッシュ文字列を追加することであり、例えば、オブジェクトをアップロードする時に、パスキー値に対してSHA1またはMD5ハッシュ計算を行い、かつプレフィックスとして数ビットの文字を選択してキー値名称に追加し、通常2〜4ビットの文字ハッシュプレフィックスは必要を満たすことができます。
<pre>
<font color="red">faf1</font>-20170701/log120000.tar.gz
<font color="red">e073</font>-20170701/log120500.tar.gz
<font color="red">333c</font>-20170701/log121000.tar.gz
<font color="red">2c32</font>-20170701/log121500.tar.gz
</pre>

>！Tencent Cloud COSのキー値インデックスがUTF-8バイナリ順でインデックスされるため、オブジェクトリスト（GET Bucket）操作を実行する時に、元の完全な20170701プレフィックス構造を取得するために、65536回のオブジェクトリスト操作を開始する必要があります。

### 列挙値プレフィックスの追加

オブジェクトキーの検索使いやすさを保留しようとする場合、ファイルタイプに対していくつかのプレフィックスを列挙でき、オブジェクトのグループ化を実現し、同じ列挙値のプレフィックスは位置するインデックスパーティションのパフォーマンスを共有します。

```
logs/20170701/log120000.tar.gz
logs/20170701/log120500.tar.gz
logs/20170701/log121000.tar.gz
...
images/image001/indexpage1.jpg
images/image002/indexpage2.jpg
images/image003/indexpage3.jpg
...
```

同じ列挙プレフィックスで、アクセス負荷が依然として高く、毎秒500のリクエストを持続的に超える場合、上記16進数のハッシュプレフィックスの追加方式を参照し、列挙値の後に引き続きハッシュプレフィックスを追加して複数のインデックスパーティションを実行することができ、それによってより高いパフォーマンスの読み書きを実現します。
<pre>
logs/<font color="red">faf1</font>-20170701/log120000.tar.gz
logs/<font color="red">e073</font>-20170701/log120500.tar.gz
logs/<font color="red">333c</font>-20170701/log121000.tar.gz
...
images/<font color="red">0165</font>-image001/indexpage1.jpg
images/<font color="red">a349</font>-image002/indexpage2.jpg
images/<font color="red">ac00</font>-image003/indexpage3.jpg
...
</pre>

### キー値文字列の反転

ビジネスで連続的に増加するIDまたは日付を使用する必要がある場合、または多数の連続的なプレフィックスオブジェクトを一度にアップロードする必要がある場合、下記典型的な使用方法のとおりです：

```
20170701/log0701A.tar.gz
20170701/log0701B.tar.gz
20170702/log0702A.tar.gz
20170702/log0702B.tar.gz
...
id16777216/album/hongkong/img20170701121314.jpg
id16777216/music/artist/tony/anythinggoes.mp3
id16777217/video/record20170701121314.mov
id16777218/live/show/date/20170701121314.mp4
...
```

上記のようなキー値命名方式では、`2017`と`id`をプレフィックスとするキー値が位置するインデックスパーティションは非常に使い尽くされやすく、この時、キー値のプレフィックスの一部を反転した後、ある程度のランダム性が実現される。

```
10707102/log0701A.tar.gz
10707102/log0701B.tar.gz
20707102/log0702A.tar.gz
20707102/log0702B.tar.gz
...
61277761di/album/hongkong/img20170701121314.jpg
61277761di/music/artist/tony/anythinggoes.mp3
71277761di/video/record20170701121314.mov
81277761di/live/show/date/20170701121314.mp4
...
```

## 高いGETリクエスト負荷

主なビジネス負荷がGETリクエスト（即ち、ダウンロードリクエスト）を主とする場合、上記基準に従うこと、またTencent Cloud CDNサービスと組み合わせて使用することをお勧めします。

Tencent Cloud CDNは、中国および世界中にわたるエッジアクセラレーションノードを利用して、コンテンツをユーザーに配信する時に遅延を低減し速度を向上することができ、ホットスポットファイルに対してプリチャージ方式でキャッシュすることをサポートでき、それによってCOSにプルするGETリクエストの数を減らします。[CDNとCOSを組み合わせるベストプラクティス](https://cloud.tencent.com/document/product/436/8467)を参照してください。
