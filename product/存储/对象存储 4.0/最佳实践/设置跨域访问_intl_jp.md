## 同一生成元ポリシー
同一生成元ポリシーは、あるソースからロードされたドキュメントまたはスクリプトが別のソースからのリソースとやり取りする方法を制限するもので、潜在的な悪意のあるファイルを隔離するための重要なセキュリティメカニズムです。同じプロトコル、同じドメイン名（またはIP）、および同じポートは同じドメインとみなされ、１つのドメイン内のスクリプトにはローカルドメイン内の権限のみを有し、即ちローカルのスクリプトはローカルドメイン内のリソースへの読み取りと書き込みのみが許可され、他のドメインのリソースへのアクセスは許可されません。このようなセキュリティ制限は、同一生成元ポリシーと呼ばれています。
### 同一生成元の定義
２つのページのプロトコル、ドメイン名とポート（ポートが指定されている場合）が同じであれば、同一生成元とみなされます。次の表に、`http://www.example.com/dir/page.html`の同一生成元テストの例を示します。

| **URL** | **結果** | **原因** |
|:---------:|:---------:|:---------:|
| `http://www.example.com/dir2/other.html` | 成功 | プロトコル、ドメイン名、ポートが同じ |
| `http://www.example.com/dir/inner/another.html` |	成功 | プロトコル、ドメイン名、ポートが同じ |
| `https://www.example.com/secure.html` |	失敗	| プロトコルが異なる（HTTPS） |
| `http://www.example.com:81/dir/etc.html` |	失敗 |	ポートが異なる（81） |
|`http://news.example.com/dir/other.html` |	失敗 |	ドメイン名が異なる |
### クロスオリジンアクセス
CORS（Cross-Origin Resource Sharing）メカニズムはオリジン間のアクセスと略称され、Webアプリケーションサーバーのオリジン間のアクセス制御が許可されることで、オリジン間のデータ転送を安全に行うことになります。CORSは、ブラウザとサーバー両方のサポートが必要です。現在、この機能はすべてのブラウザによりサポートされており、IEブラウザにはIE10以上のバージョンが必要です。
CORS通信プロセス全体は、ユーザーの介入なしにブラウザが自動的に実行されます。開発者にとって、CORS通信と同一生成元のAJAX通信とは差別がなく、コードは完全に同じです。ブラウザはAJAXが生成元間を要求することを発見すると、添付のヘッダー情報が自動的に追加され、添付の要求が１回発生することもありますが、ユーザーは認識しません。
したがって、CORS通信を実現する重要な点はサーバーです。サーバーがCORS APIを実装すると、生成元間の通信が可能になります。

## CORSの主な使用シーン
アクセス権限を制御するのはサーバーではなくブラウザであるため、CORSはブラウザを使用している場合にのみ使用できます。。したがって、他のクライアントを使用する場合、クロスオリジンの問題を心配する必要はありません。
CORSは主に、ブラウザ側でAJAXを使用してCOSのデータに直接アクセスし、ユーザー自身のアプリケーションサーバーで中継せずに、アップロードとダウンロードを実現することに応用されます。COSとAJAXテクノロジーを同時に使用するWebサイトでは、CORSを使用してCOSとの直接通信を実現することをお勧めします。
## COSのCORSへのサポート　
COSはCORS規則の構成をサポートし、ニーズに応じて適切なクロスオリジンリクエストを許可または拒否します。当該CORS規則の構成はバケットレベルに属しています。
CORSリクエストが通過されるかどうかはCOSの身分認証などと完全に独立しており、即ち、COSのCORS規則はCORSに関連するHeaderを付加するか否かを決定するための１つの規則にすぎません。当該リクエストを遮断するかどうかは、ブラウザによって決定されます。
現在、COSのすべてのObject関連APIはCORS関連の認証を提供しており、また、Multipart関連のAPIもCORS認証を完全にサポートしています。
> 同じブラウザ上で実行している`www.a.com`および`www.b.com`からの２つのページが同時に同じクロスオリジンリソースをリクエストした場合、`www.a.com`からのリクエストが最初にサーバーに届くと、サーバーはAccess-Control-Allow-OriginのHeaderをリソースに渡し、`www.a.com`のユーザーに返します。この時、`www.b.com`はまたリクエストを開始し、ブラウザはCacheの前回のリクエスト応答をユーザーに返します。HeaderのコンテンツとCORSのリクエストが一致しない場合、`www.b.com`のリクエストは失敗します。

## CORS設定例
次の簡単な例では、AJAXを使用してCOSからデータを取得するための構成手順を説明します。例で使用されているバケット（Bucket）権限はパブリック（Public）に構成されており、アクセス権限がプライベートであるバケットは、リクエストに署名を添付する必要があり、ほかの構成は同じです。
次の例では、使用されているバケット名はcorstestで、バケットのアクセス権限はパブリック読み取り・プライベート書き込みです。
### CORSを設定する前
1. **ファイルが正常にアクセスされていることを確認**
test.txtの文書ドキュメントをcorstestにアップロードします。test.txtのアクセスアドレスは、`http://corstest-125xxxxxxx.cos.ap-beijing-1.myqcloud.com/test.txt`です。
curlを使用して当該文書ドキュメントに直接アクセスするには、ファイルのアドレスを次のアドレスに置き換えてください。
```
curl http://corstest-125xxxxxxx.cos.ap-beijing-1.myqcloud.com/test.txt
```
test.txtファイルの内容（test）を返します。当該ドキュメントが正常にアクセス可能であることを示します。
![画像0](//mc.qcloudimg.com/static/img/5e1740ac46efd2ddcb8258448af27815/image.png)
2. **AJAXテクノロジーを使用したファイルへのアクセス**
ここでは、AJAXテクノロジーを使用してtest.txtファイルに直接アクセスしてみましょう。
 1. 簡単なHTMLファイルを作成するには、次のコードをローカルにコピーしてHTMLファイルに保存した後、ブラウザで開きます。カスタムヘッダーが設定されていないため、このリクエストについて事前チェックする必要はありません。
```
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>
<a href="javascript:test()">Test CORS</a>
<script>
    function test() {
        var url = 'http://corstest-125xxxxxxx.cos.ap-beijing-1.myqcloud.com/test.txt';
        var xhr = new XMLHttpRequest();
        xhr.open('HEAD', url);
        xhr.onload = function () {
            var headers = xhr.getAllResponseHeaders().replace(/\r\n/g, '\n');
            alert('request success, CORS allow.\n' +
                'url: ' + url + '\n' +
                'status: ' + xhr.status + '\n' +
                'headers:\n' + headers);
        };
        xhr.onerror = function () {
            alert('request error, maybe CORS error.');
        };
        xhr.send();
    }
</script>
</body>
</html>
```
 2. ブラウザでHTMLファイルを開き、【Test CORS】ボタンをクリックしてリクエストを送信すると、「Access-Control-Allow-OriginというHeaderが見つからなかったため、アクセスできません」というエラーメッセージが表示されます。サーバーにCORSが構成されていないからです。
 ![エラーメッセージ表示](//mc.qcloudimg.com/static/img/b495296d08ddac2f5d8eacc0e9203c59/image.png)
 3. アクセスに失敗した際、再びHeader画面で原因を確認すると、ブラウザからOrigin付きのRequestが送信されているため、クロスオリジンリクエストであることがわかります。
![Headerのチェック](//mc.qcloudimg.com/static/img/26976dee6cb15736e9aff86d353d5738/image.png)
> Webページをサーバーに構築し、アドレスは`http://127.0.0.1:8081`であるため、Originは`http://127.0.0.1:8081`です。

### CORSの設定
アクセスに失敗した原因を確認したら、バケットに関連するCORSを設定することで、これらの問題を解決できます。COSコンソールはCORS設定を行うことができます。この例では、コンソールでCORS設定を行います。CORS設定が特に複雑でない場合は、コンソールでCORSを設定することをお勧めします。
#### I. COSコンソールにログインして、構成画面に進みます。
[COSコンソール]()をクリックしてログインし、【Bucketリスト】をクリックし、関連するバケット（corstestなどのBukect）に進み、【基本構成】をクリックし、クロスオリジンアクセスCORS設定項目を見つけることができます。
![画像4](//mc.qcloudimg.com/static/img/7a08a4ad4199580265a0359f2b39eafc/image.png)

#### II. CORS規則のオンと設定
1. 【編集】をクリックしてCORSステータスをオンにし、【+新規規則】をクリックすると、設定ページが表示され、最初の規則を追加します。最も緩和の構成は次の通りです。
![](//mc.qcloudimg.com/static/img/198d6464fe3846451b6afc2b71cb0b78/image.png)
> **注意：**
> CORS設定は一つ一つの規則で構成されており、最初の規則から順に一致し、最初に一致した規則を基準とします。

#### 検証結果
構成が完了したら、test.txtテキストファイルへのアクセスを再試行します。結果は下記のような場合、リクエストへのアクセスが正常に行われるようになります。
![アクセスの成功](//mc.qcloudimg.com/static/img/9d3f4370b337e73090efae2c2ef199f4/image.png)

### トラブルの解決とアドバイス
クロスオリジンアクセスによる問題を解決するには、CORSをすべてのドメイン間のリクエストを許可する最も緩和の構成に設定します。当該構成もエラーが発生する場合、エラーがCORSではなく他の部分に発生していることを示します。

最も緩和の構成のほかに、よりきめ細かな制御メカニズムを構成して、目的に合わせた制御を行うこともできます。例えば、この例では、次のようにな最小限の構成で一致が成功することになります。
![](//mc.qcloudimg.com/static/img/c3cba398e89f643c58a742e720dbd955/image.png)
したがって、大部分のシーンでは、安全性を確保するために、自分の使用シーンに応じて最小限の構成を使用することをお勧めします。
## CORS構成項目の説明
CORS構成には次の項目があります。
### ソースOrigin
クロスオリジンリクエストを許可するソース。
- 複数のソースを同時に指定でき、１行に１つのみ入力できます。
- 構成が`*`をサポートし、すべてのドメイン名が許可されることを示すため、推奨しません。
- `http://www.abc.com`のような個々の具体的なドメイン名をサポートします。
- `http://*.abc.com`のような二次的な汎ドメイン名をサポートしますが、一行には`*`が１つのみ許可されます。
- プロトコル名HTTPまたはHTTPSを見逃さないように注意してください。ポートがデフォルトの80でない場合、ポートを追加する必要があります。
### 操作メソッド
許可されているクロスオリジンリクエストメソッド（１つまたは複数）を列挙します。
例えば：GET、PUT、POST、DELETE、HEAD。

### Allow-Header
許可されているクロスオリジンHeaderリクエスト。
- 複数のソースを同時に指定でき、１行に１つのみ入力できます。
- Headerは見逃しやすいため、特別な需要がない場合、「*」に設定することを推奨し、すべてを許可することを示します。
- 大文字と小文字は区別されません。
- Access-Control-Request-Headersで指定された各Headerは、いずれもAllowed-Headerでの対応項目が必要です。

### Expose-Header
ブラウザに露出されたHeaderのリスト、即ちユーザーがアプリケーションからアクセスする応答ヘッダー（例えばJavascriptのXMLHttpRequestオブジェクト）です。
- 特定の構成要件は、アプリケーションのニーズに応じて決定されます。デフォルトでは、Etagを記入することをお勧めします。
- ワイルドカードの使用は許可されません。大文字と小文字は区別されず、1行に1つしか入力できません。

### タイムアウトMax-Age
特定のリソースに対するブラウザのプリフェッチリクエスト（OPTIONSリクエスト）が結果を返すキャッシュ時間（単位：秒）。特に問題がない場合は、60秒など、少し大きめに設定できます。
当該項目はオプションの構成項目です。
