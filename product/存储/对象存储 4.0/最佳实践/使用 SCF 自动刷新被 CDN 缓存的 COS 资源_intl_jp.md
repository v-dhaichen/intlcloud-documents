## 概要
本実践は、Tencent Cloud COSを使用してオブジェクトをアップロードする際に、サーバーなしクラウド関数SCFを使用してCDNで指定されたキャッシュファイルを自動的に更新し、アップデートされたリソースを自動的に取得できるように導きます。

>!この機能を使用するには、CDN関連のAPI呼び出し回数の制限に従うことになります。[キャッシュリフレッシュ](https://cloud.tencent.com/document/product/228/6299#url-.E5.88.B7.E6.96.B0)のドキュメントを参照してください。

## 実践の背景

静的なコンテンツをアップデートする必要がある場合では、通常、アップデートされたバージョンのリソースをCOSに上書きアップロード或は削除します。構成したCDNキャッシュの期限切れ時間が長い場合、CDNの一部のエッジノードでは古いリソースがキャッシュされたままになることがあります。キャッシュの期限切れ時間が短すぎると、加速効果に影響します。詳細については、[キャッシュ期限切れの構成](https://cloud.tencent.com/document/product/228/6290)の関連情報を参照してください。

上記の状況に基づいて、CDNコンソールの[キャッシュリフレッシュ](https://cloud.tencent.com/document/product/228/6299)機能を使用して、指定されたURLを手動的に更新し、無効なキャッシュファイルの削除、或はリソースのアップデートが必要となります。

本文では、COSとSCFの機能特性を考慮して、COSファイルをアップデートする際に、CDNキャッシュを自動的に更新する効果を実現します。

## 準備作業

1. Tencent Cloudアカウントは、COS、CDN、SCFなどの製品へのアクセス権限を備えている必要があります。
2. バケットを作成し、当該バケットにCDN 加速ドメイン名をバインディングします。
3. COSバケットの所属地域でSCF 製品機能が利用可能であることを確保します。地域間の呼び出しがサポートされません。
4. CDNリフレッシュAPIを呼び出せるクラウドAPI暗号鍵を準備し、[SCFリフレッシュサンプルコード](https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip)をダウンロードします。

## 作業手順

> 本実践例では、Node.js言語のサンプルコードを使用します。

### 1.SCF関数の作成
>!作成された関数の所属地域はCOSバケットの地域と一致する必要があります。

1）[SCFコンソール](https://console.cloud.tencent.com/scf/)にログインし、関数サービスをクリックし、静的コンテンツと同じ地域を選択した上で、関数を作成します。次の図のようになります。
![](https://main.qcloudimg.com/raw/332edc2828575a4c802a9af9cb233b08.png)
2）「新規関数」画面で、「空関数」を選択し、関数名（refresh_cdnなど）を入力して実行環境を設定します（サンプルコードはNode.js言語を使用しているため、実行環境はNodejs 6.10に設定されています）。構成をしっかり確認した上、【完了】をクリックします。次の図のようになります。　
![](https://main.qcloudimg.com/raw/70e9dbae0471dd8cd50ffa724eb089f4.png)

### 2. 関数の構成

空関数を作成したら、相応の関数コードを追加し、関数が正しく機能するようにトリガー方法を設定する必要があります。

#### 2.1 関数コードの構成

1）[SCFのCDNリフレッシュサンプルコード](https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip)をダウンロードします。
2）すべてのファイルを解凍し、index.jsを探して開きます。
3）コードをCDNリフレッシュAPIの呼び出せる権限を持っているSecretId、SecretKey、およびリフレッシュする必要のあるドメイン名に置き換えます。次の図のようになります。
![](https://main.qcloudimg.com/raw/b2b0eba560e3229fc402490f0737712b.png)
4）Tencent Cloudの海外 CDNにバインディングされているドメイン名を呼び出しリフレッシュする場合では、コードの中にある`RefreshCdnUrl`を`RefreshCdnOverSeaUrl`に変更する必要があります。

#### 2.2 関数コードのアップロード

1）変更されたコードおよびその他のファイルをzipフォーマットに再圧縮します。
2）SCFコンソールで、「関数コード」タブを選択し、「提出方法」を「zipパッケージをローカルにアップロード」に設定し、再圧縮できていたzipフォーマットのファイルを選択して【アップロード】をクリックします。次の図のようになります。
![](https://main.qcloudimg.com/raw/9672da05b98748a5ef06da393ec64d04.png)

#### 2.3 トリガー方法の追加

1）SCFコンソールで、「トリガー方法」タブを選択し、【トリガー方法の追加】をクリックします。
2）「トリガー方法」を「COSトリガー」に設定し、COSリソースをリフレッシュするバケットを選択します。次の図のようになります。
![](https://main.qcloudimg.com/raw/8f3b5efab6a30b008fd1b8e12eafb1e0.png)
3）実際のニーズに基づいて、イベントタイプを設定します。
- COSにアップロードされたオブジェクトのみを上書きするためにCDNの内容を自動的にリフレッシュする場合では、「イベントタイプ」を「ファイルアップロード」に設定する必要があります。
- 削除動作も自動的にリフレッシュする必要がある場合は、トリガー方法を再度追加して、「イベントタイプ」を「ファイル削除」に設定する必要があります。

4）「今すぐ有効にする」チェックボックスをオンにします。
5）最後に構成内容を確認した上、「保存」をクリックします。

### 3. テスト
>!CDNは非同期処理ですので、照合処理するときに数分後に発効します。

構成完了した後に、このバケットに新しいオブジェクトをアップロードして検証できます。
1）COSコンソールで、同名のアップデートファイルをアップロードします。次の図のようになります。
詳細については、[オブジェクトのアップロード](https://cloud.tencent.com/document/product/436/13321)を参照してください。
![](https://main.qcloudimg.com/raw/66ba3a7ea298f2f4e240f76ebe76df03.png)
2）アップロードした後に、SCFコンソールの「実行ログ」で正常に起動したログを照合できます。次の図のようになります。
![](https://main.qcloudimg.com/raw/99b84dec0d0d3599fbffecef2d8e4d95.png)
3）CDNコンソールの「キャッシュリフレッシュ - 処理履歴」で、リフレッシュを自動的に呼び出したログを照合できます。

4）上記のテストを通過した場合に、CDN加速後のURLにアクセスして最新のリソースを取得できます。
