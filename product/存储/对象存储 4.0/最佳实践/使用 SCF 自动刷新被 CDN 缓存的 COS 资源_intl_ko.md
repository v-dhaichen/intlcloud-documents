## 소개
본 실행은 Tencent Cloud COS를 사용하여 객체를 업로드할 때 SCF를 빌려 자동으로 CDN의 지정된 캐시 파일을 새로고침하는 것을 구현하여 업데이트 후의 리소스를 자동으로 획득할 수 있도록 소개합니다.

>!이 기능의 사용은 CDN 관련 API 호출 횟수의 제한을 따르며 자세한 사항은 [캐시 업데이트](https://cloud.tencent.com/document/product/228/6299#url-.E5.88.B7.E6.96.B0) 문서를 참조하십시오.

## 배경

정적 콘텐츠를 업데이트해야 할 경우 일반적으로 COS에 덮어쓰기 하여 하나의 업데이트 버전의 리소스를 업로드하거나 해당 리소스를 삭제합니다. 귀하가 구성한 CDN 캐시 만료 시간이 비교적 길 경우 CDN의 일부 엣지 서버는 여전히 이전 리소스를 캐시할 수 있습니다. 캐시 만료 시간이 너무 짧을 경우 가속 효과에 영향을 끼칠 수 있습니다. 자세한 사항은 [캐시 만료 구성](https://cloud.tencent.com/document/product/228/6290)의 관련 정보를 참조하십시오.

상기 상황에 따라 CDN 콘솔의 [캐시 업데이트](https://cloud.tencent.com/document/product/228/6299) 기능을 사용하여야 하며 지정된 URL을 수동으로 새로고침 조작을 진행하여 무효한 캐시 파일의 삭제 또는 리소스 업데이트를 구현합니다.

본 문서에서는 COS와 SCF의 기능 특성을 결합하여 COS 문서를 업데이트할 경우 CDN 캐시 업데이트를 자동으로 진행하는 효과를 구현합니다.

## 준비 작업

1. Tencent Cloud 계정은 COS, CDN, SCF 등 제품의 접근 권한을 갖추어야 합니다.
2. 버킷을 생성하고 해당 버킷에 CDN 가속 도메인 이름이 바인딩되어야 합니다.
3. COS의 버킷 소재 지역이 SCF 제품 기능을 지원한다는 것을 확인합니다. 지역 간 호출은 잠시 지원하지 않습니다.
4. CDN 새로고침 API를 호출 가능한 클라우드 API 키를 준비하고 [SCF로 CDN 업데이트 샘플 코드](https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip)를 다운로드합니다.

## 절차

> 본 인스턴스는 Node.js 언어 예제 코드를 예시로 합니다.

### 1. SCF 함수 생성
>!생성한 함수 소재 지역은 COS 버킷 지역과 일치해야 합니다.

1) [SCF 콘솔](https://console.cloud.tencent.com/scf/)에 로그인하고 함수 서비스를 클릭하여 정적 콘텐츠와 같은 지역을 선택한 다음 함수를 생성합니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/332edc2828575a4c802a9af9cb233b08.png)
2) “함수 생성” 페이지에서 “블랭크 함수”를 선택하고 함수 이름(예, refresh_cdn)을 입력한 다음 실행 환경을 설정합니다(샘플 코드는 Node.js 언어를 사용했으므로 실행 환경을 Nodejs 6.10으로 설정합니다). 구성이 틀림없는지를 확인한 후 [완료]를 클릭하면 됩니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/70e9dbae0471dd8cd50ffa724eb089f4.png)

### 2. 함수 구성

블랭크 함수를 생성 완료 후 해당되는 함수 코드를 추가하고 트리거 방식을 설정하여 함수가 정상적으로 작동되게 합니다.

#### 2.1 함수 코드 구성

1) [SCF로 CDN 업데이트 샘플 코드](https://main.qcloudimg.com/raw/757b646eb68e9b9a5b2fc4bf0fed2492/scf_about_cdn_refresh.zip)를 다운로드합니다.
2) 모든 파일을 압축 해제하고 그 중에서 index.js 파일을 찾아 엽니다.
3) 코드에서 CDN 새로고침 API를 호출하는 권한을 가진 SecretId, SecretKey와 새로고침이 필요한 도메인 이름으로 수정하고 대체합니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/b2b0eba560e3229fc402490f0737712b.png)
4) Tencent Cloud 해외 CDN에 바인딩된 도메인 이름을 호출하고 새로고침해야 할 경우 코드 중의 `RefreshCdnUrl`을 `RefreshCdnOverSeaUrl`으로 수정하십시오.

#### 2.2 함수 코드 업로드

1) 수정된 코드와 기타 파일을 다시 zip 포맷으로 압축합니다.
2) SCF 콘솔에서 “함수 코드” 탭을 선택하고 “제출 방법”을 “zip 패킷 로컬 업로드”로 설정한 다음 방금 압축한 zip 포맷 파일을 선택하고 [업로드]를 클릭합니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/9672da05b98748a5ef06da393ec64d04.png)

#### 2.3 트리거 방식 추가

1) SCF 콘솔에서 “트리거 방식” 탭을 선택하고 [트리거 방식 추가]를 클릭합니다.
2) “트리거 방식”을 “COS 트리거”로 설정하고 업데이트해야 할 COS 리소스의 버킷을 선택합니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/8f3b5efab6a30b008fd1b8e12eafb1e0.png)
3) 실제 수요에 따라 이벤트 유형을 설정합니다.
- 단지 CDN 접근을 자동 새로고침하여 COS의 객체에 덮어쓰기 방식으로 업로드하고자 할 경우 “이벤트 유형”을 “파일 업로드”로 설정해야 합니다.
- 동시에 삭제 행위에 대해서도 자동 새로고침을 진행하고자 할 경우 하나의 트리거 방식을 더 추가하고 “이벤트 유형”을 “파일 삭제”로 설정해야 합니다.

4) 즉시 사용을 선택합니다.
5) 마지막으로 구성 정보가 틀림없는지를 확인한 다음 [저장]을 클릭합니다.

### 3. 테스트
>! CDN은 비동기 조작이므로 조작 조회 시 잠시 기다려 주십시오.

구성 완료 후 해당되는 버킷에 새 객체를 업로드하여 인증할 수 있습니다.
1) COS 콘솔에서 같은 이름의 업데이트 파일을 업로드합니다. 다음 그림과 같습니다.
자세한 조작은 [업로드 객체](https://cloud.tencent.com/document/product/436/13321) 문서를 참조하십시오.
![](https://main.qcloudimg.com/raw/66ba3a7ea298f2f4e240f76ebe76df03.png)
2) 업로드 완료 후 SCF 콘솔의 “실행 로그”에서 호출에 성공한 로그를 조회할 수 있습니다. 다음 그림과 같습니다.
![](https://main.qcloudimg.com/raw/99b84dec0d0d3599fbffecef2d8e4d95.png)
3) CDN 콘솔의 “캐시 업데이트 - 작업 기록”에서 자동으로 업데이트를 호출한 기록을 조회할 수 있습니다.

4) 위의 테스트가 통과되면 CDN 가속 후의 URL에 접근하여 최신 리소스를 획득할 수 있습니다.
