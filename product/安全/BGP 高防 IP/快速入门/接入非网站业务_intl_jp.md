

本書では、非Webサイト系サービスユーザーがサービスをAnti-DDoS Advancedインスタンスに導入し防護構成を検証する方法を説明します。

## 前提条件

- 転送規則を追加する前は、**Anti-DDoS Advancedインスタンスの購入**を完了する必要があります。
- サービスドメイン名のDNS情報を変更する前は、**ドメイン名解析製品**の購入を完了する必要があります。

## 操作プロセス

![](https://main.qcloudimg.com/raw/32e0a64988437a3ccbb0a601ff96aae4.png)

## 操作ステップ
<span id="step1"></span> 
### 転送規則の構成

   1. [Anti-DDoS Advancedコンソール](https://console.cloud.tencent.com/dayu/bgpip)にログインし対象インスタンスを見つけ、インスタンスIDをクリックして構成ページに入ります。
   2. **転送規則**構成欄において、**新規作成**をクリックして作成します。

   ![](https://main.qcloudimg.com/raw/d40177109885d3be2cf05e2e8fd2906c.png)
    
  3. 実際のニーズに応じたパラメータを構成し、**OK**をクリックします。

 - 転送プロトコル：現在TCPとUDPをサポートします。
 - 転送ポート：アクセス用防御IPポートです。オリジンサーバーと同じのポートをお勧めします。Anti-DDoS Advancedは、843、1433、1434、3306、3389、36000および56000ポートを転送ポートとしてサポートしません。
 - オリジンサーバーポート：ユーザービジネスサーバーの実際のポート。
 - オリジンサーバーIP：書き込みオリジンサーバーのIPアドレス。複数のオリジンサーバーIPに対応する時、すべてを入力し、Enterキーで各IPを仕切ります。最大20個のIPをサポートします。Anti-DDoS Advancedは、ポーリングのCLBアルゴリズムを採用してサービストラフィックをプルします。
 
 ![](https://main.qcloudimg.com/raw/390094dc48997c02e9009ec8757ee337.png)

<span id="step2"></span> 
### プル型IPアドレス範囲の許可

オリジンサーバーがAnti-DDoS Advancedプル型IPをブロックしてサービス妨害を避けるために、オリジンサーバーのファイアウォール、Webアプリケーションファイアウォール、IPS侵入防護システム、トラフィック管理等のハードウェアデバイスにホワイトリストポリシーを設定し、オリジンサーバーのCVMファイアウォールとその他のすべてのセキュリティ系ソフトウェア（例えば、Safedog等）の防護機能を無効にし、またはホワイトリストポリシーを設定することをお勧めします。それにより、Anti-DDoS Advancedプル型IPがオリジンサーバーのセキュリティポリシーの影響を受けることはありません。
Anti-DDoS Advancedプル型IPアドレス範囲の詳細については、Tencent Cloudのアフタサービスにご連絡ください。

<span id="step3"></span> 
### ローカル検証の構成

転送構成を完了した後、Anti-DDoS Advancedインスタンスの防御IPが転送規則に従って関連ポートのメッセージをオリジンサーバーの対応ポートに転送します。
サービスの安定性を最大限に確保するために、サービスの全面切替前にロカールテストの実行をお勧めします。具体的な検証方法は以下の通りです。

- **IPでアクセスするサービス**
  直接にIPでやり取りをするサービス（例えば、ゲームサービス）について、`telnet`コマンドで防御IPポートにアクセスして、繋がっているかを確認します。ロカールのクライアントに直接にサーバーIPを入力できれば、防御IPを入力しテストを行い、ロカールのクライアントが正常に繋がっているかどうかを確認します。
  例えば、防御IPは10.1.1.1、転送ポートは1234、オリジンサーバーIPは10.2.2.2、オリジンサーバーポートは1234。ロカールから`telnet`コマンドで10.1.1.1:1234にアクセスし、`telnet`コマンドで接続できれば、転送は成功します。
- **ドメイン名でアクセスするサービス**
  ドメイン名でアクセスするサービスについて、以下の方法により構成の有効性を検証します。
 1. ロカールのhostsファイルを変更し、ロカールから防護対象サーバーへのリクエストが高防御を経由するようにします。
   Windowsシステムを例とします。
   1. ロカールのコンピューターC:\Windows\System32\drivers\etc配下のhostsファイルを開き、末尾に次の内容を追加します。
   `<防御IPアドレス> <防護対象Webサイトのドメイン名>`
   例えば、防御IPは10.1.1.1、ドメイン名は [www.qq.com](www.qq.com)であれば、以下を追加します。
   `10.1.1.1       www.qq.com`
   2. hostsファイルを保存します。
 2. ロカールコンピュータで防護対象ドメイン名に対し`ping`コマンドを実行します。
   名前解決したIPアドレスはhostsファイルにバインディングされる防御IPアドレスであれば、転送は成功します。
 > ?名前解決したIPアドレスはオリジンサーバーアドレスであれば、Windowsのコマンドプロンプトから`ipconfig/flushdns`コマンドを実行し、ロカールのDNSキャッシュをリフレッシュします。

  3. hostsのバインディングが有効になったことを確認した後、ドメイン名で検証を行います。
   正常にアクセスすれば、構成が有効となります。

> ?正確な方法を使っても検証に失敗した場合、[Anti-DDoS Advancedコンソール](https://console.cloud.tencent.com/dayu/bgpip)にログインして構成が正しいかを確認してください。構成ミスと検証方法のエラーを排除しても問題が相変わらず存在した場合、Tencent Cloudアフターサービスにご連絡ください。

<span id="step4"></span>
### サービスドメイン名のDNS名前解決の変更

  Anti-DDoS Advancedに転送規則グレープをバインディングした後、ユーザーはAnti-DDoS Advancedの転送ポートからオリジンサーバーのオリジンサーバーポートまでの疎通確認を行います。構成サービスIPをAnti-DDoS Advancedに指定すると、導入構成が完了します。
  
  サービスがDNS名前解決サービスを利用する場合、DNSサービス業者にてドメイン名の名前解決を変更し、元のサービスIPアドレスをバインディングされた防御IPアドレスに変更することができます。
  
  DNSの名前解決を変更し、すべてのユーザーのアクセストラフィックが防御IPを経由して、オリジンサーバーに戻るよう（すべてのトラフィックを防御IPに引くことに相当する）にします。

