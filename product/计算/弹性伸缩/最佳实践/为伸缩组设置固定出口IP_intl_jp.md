この節では、クラスタが自発的に外部にアクセスする必要がある場合、外部アクセス固定IPの設定方法を説明します。

## 需要シナリオ

スケーリンググループ中のクラスタには、同時に以下の3つのニーズがある場合：
- CLBからリクエストを受信します
- クラスタCVMが自発外部アクセスを要します
- 外部アクセスときに**固定**のパブリックネットワークIPを使用します

以下の方案で設定します。

## 方案概要
1. CLBを介して外部リクエストを受信して応答します
2. CVMをVPCのサブネットに配置し、ルーティングテーブルをNATゲートウェイに指定し、自発的な外部アクセスのリクエストはNATゲートウェイのパブリックネットワークIPからまとめて送信されます
3. スケーリンググループのネットワーク属性をこのサブネットに設定すると、拡張されたCVMがNATゲートウェイで自発的に外部にアクセスできます

下図のように示す。

![](https://mc.qcloudimg.com/static/img/9cccdddfe99dbc065c97cad27448ed9f/image.png)



## 設定方法

### 第1ステップ：VPCとサブネットを作成します

#### **1. VPCの作成**

1. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバーの【VPC】をクリックするか、またはTencent Cloudの[VPC紹介画面](https://cloud.tencent.com/product/vpc.html)の【今すぐ体験】ボタンを押し、[VPCコンソール](https://console.cloud.tencent.com/vpc/)に入ります。

2. リストの上方のプルダウンボックス中の地域を選択し、【新規作成】をクリックしVPCを作成します。例えば、地域「華北地区（北京）」を選択します。

3. VPCとサブネットの名前と CIDRを入力し、サブネットのAvailability Zoneを選択します。

4. 【新規作成】をクリックします。


#### **2. サブネットの作成**

1. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバー【VPC】をクリックし、左側のナビゲーションバー中の【サブネット】をクリックします。プルダウンボックス中の地域とVPCを選択します。
![](https://mc.qcloudimg.com/static/img/02c52c44678a56597b4d7053f8f8c467/3.jpg)

2. 【新規作成】をクリックし、サブネットワーク名称、CIDR、Availability Zone、関連ルーティングテーブルを入力します。次は【新規作成】をクリックして確認します。

3. 新規作成後、CVMをこのサブネットに購入できます。


### 第2ステップ：NATゲートウェイを作成します
#### **1. 購入**
1. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、【VPC】タブを選択し、【NATゲートウェイ】を選択します。

2. 左上の【新規作成】ボタンをクリックし、ポップアップボックスに以下のパラメータを順次入力または決定します。
	- ゲートウェイ名称
	- ゲートウェイタイプ（ゲートウェイタイプ作成後変更可能）
	- NATゲートウェイサービスのVPC（上記作成したVPC）
	- NATゲートウェイにElastic IPを割り当て、このIPは今後CVMの外部アクセスの固定IPです

3. 選択終了後、【OK】ボタンをクリックすると、NATゲートウェイの作成を完了します。

4. NATゲートウェイを作成した後、サブネットトラフィックをNATゲートウェイに指定するために、VPCコンソールのルーティングテーブルぺページでルーティング規則を構成する必要があります。

#### **2. ルーティングテーブルの設定（重点）**
1. [Tencent Cloudコンソール](https://console.cloud.tencent.com/)にログインし、ナビゲーションバー【VPC】をクリックし、[VPCコンソール](https://console.cloud.tencent.com/vpc/vpc?rid=8)に入り、【ルーティングテーブル】を選択します。

2. ルーティングテーブルリストで、Internetにアクセスするサブネットに関連付けられているルーティングテーブルIDをクリックし、ルーティングテーブル詳細画面に入り、ルーティングポリシーで【編集】ボタンをクリックします。

3. 1行追加をクリックし、目的側（このようなシナリオで「0.0.0.0/0」を入力します）をクリックします。次のホップタイプに【NATゲートウェイ】を選択し、作成したNATゲートウェイIDを選択し、OKをクリックします。
![](https://mc.qcloudimg.com/static/img/3cd89bc5f80c66fd88c27cfc4e08d785/1.jpg)

ここまで、このサブネット中のCVMは、パブリックネットワークIPがなくても、NATゲートウェイを介して自発的に外部アクセスが可能で、外部にとって依然として固定IPとして使用されます。

下図のように、パブリックネットワークIPがなくかつ帯域幅が0のCVMを購入しても、自発的に外部アクセスが可能です。
![](https://mc.qcloudimg.com/static/img/17ed153e06272885b56764781d9ab581/49.jpg)
ただし、スケーリンググループがこのサブネットを識別し、このサブネットでCVMを作成することを確保する必要があります。

### 第3ステップ：スケーリンググループの設定
このステップの目的はサブネット情報をスケーリンググループに指定し、スケーリンググループが新しく拡張のCVMをサブネットに配置します。
**これで、拡張のCVMがNATゲートウェイのIPアドレスで自発的に外部アクセスを行い、固定IPの効果を果たします。**

[ASコンソール](https://console.cloud.tencent.com/autoscaling/config)で、新規作成をクリックします。

- スケーリンググループ名、起動構成（起動構成は事前に設定されます）、最大スケーリング数、最小スケーリング数、開始インスタンス数等の情報を入力します
- 「ネットワーク」と「サブネット」を選択し、上記設定したVPCとサブネットに指定します**（重要）**。

下図のように示す。
![](https://mc.qcloudimg.com/static/img/699ee5bde186a9d4686684346032eba5/16.jpg)

以上、設定完了です。

