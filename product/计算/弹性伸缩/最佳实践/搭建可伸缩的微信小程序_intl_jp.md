
## 配置アーキテクチャ
以下のアーキテクチャに基づいてWeChat Mini Programを作成でき、そのうち、ビジネスサーバークラスタおよびセッション管理サーバークラスタは、AS機能を備える必要があります。
![](https://imgcache.qq.com/open_proj/proj_qcloud_v2/gateway/solution/css/img/wx/fw-pic.png)

##なぜASを構成しますか？

以下の2つのシナリオにおいて、ASは、コストを削減し、かつビジネス継続性を向上させることができます：

1. ミニプログラムのアクセスには明らかなピーク時期と閑散期があります：計算によると、ビジネスサーバークラスタおよびセッションサーバークラスタが複数のCVMを必要とし、かつピーク時期が8時間よりも短い場合、**閑散期で固定サーバーを保留する+ピーク時期で一時サーバーを増加させる**という方式で、約30％のコストを節約できます。ASにより時限拡張および圧縮タスクを設定でき、Tencent Cloudに、ピーク時期で一時サーバーを拡張させ、閑散期で使用率の低いサーバーを回収させ終了させます。

2. ミニプログラムのアクセス量が安定していることを予想する場合、監視アラームに基づくスケーリングポリシーを構成することにより案外の高負荷に対処し、サービスを継続的に利用できるように保証し、問題解決のための時間を確保することができます。異常な高負荷は、[CC攻撃](http://baike.baidu.com/link?url=aSNcL5Q_xzDxPvFYRU3qbS11NIQXD5vwvI5yxtJTVlL0xhjAaLntwmDHVW8buUlH4bbNJqMzCPp8b1N2LX-OnwAUR3MnE9GhH-F7fomUac3)および案外のトラフィック（例えば、「FaceQ」を配布したばかりの際に予想を遥かに上回る伝播速度、または特定のイベントによる急なアクセスなど）を含みます。チャリティーウェブサイト[www.baobeihuijia.com](https://cloud.tencent.com/community/article/651089001483090830)のケースを参照してください。

>注意事項：AS機能は無料であり、拡張のCVMは秒単位で正常に課金します。

##ASは何をするのでしょうか？

ASは以下のことを助けることができます：
1. クラスタにCVMを定時的に増加または減少させます。
2. クラスタサーバーの負荷状況に基づいてCVMを適応的に増加または減少させます。
3. 増加したCVMをCLBに自動的に登録し、全自動拡張を実現します。


## 構成の前提
WeChat Mini Programの機能を構築し、[詳細な手順](https://console.cloud.tencent.com/la/guide)を参照してください。

## セッションサーバーのためのASポリシーの設定

###1.起動構成の作成

拡張する時に、**起動構成**をテンプレートとしてCVMを作成するため、事前に起動構成により地域、モデル、イメージを指定します。

1. [ASコンソール](https://console.cloud.tencent.com/autoscaling/config)にログインし、ナビゲーションバーの【起動構成】をクリックします。

2. プロジェクトおよび地域を選択し、ここで、アプレットが所在するプロジェクトおよび地域を選択する必要があることに注意してください。
![](https://main.qcloudimg.com/raw/895578616ace66061bc833165f8fb868/dj1.png)

3. 次の操作はCVMの購入と同様であり、ガイドに従って起動構成の作成を完了できます。
![](https://main.qcloudimg.com/raw/719e784a1313a12cd2d32acd965cd7b5/dj2.png)

>注：
>イメージを事前に作成する必要があり、ここで、イメージにおけるアプリケーションがオペレーティングシステムに伴って起動できることを保証する必要があり、このように拡張されたCVMは、手動で介入することなく、直接動作できます。
![](https://camo.githubusercontent.com/c58d92b133f44b3d70a0936cf4d6f087e7e0d3ee/68747470733a2f2f6d632e71636c6f7564696d672e636f6d2f7374617469632f696d672f33663363343433316137353637656261323565383633356537383865353962612f392e706e67)

### 2.スケーリンググループの作成

ASの[コンソール](https://console.cloud.tencent.com/autoscaling)で、【新規作成】をクリックし、クラスタの管理情報を以下のように入力してください：

- **名前**：必要に応じて名前を付け、ここで「セッションサーバークラスタ」を入力してください。
- **最小スケーリング数**：クラスタサーバー数の下限であり、ここで0を入力してください。
- **開始インスタンス数**：スケーリンググループを作成したばかりの際に、自動的に作成したCVMの数です。ここで0を入力してください。
- **最大スケーリング数**：クラスタサーバー数の上限であり、ここで必要に応じて入力してください。
- **起動構成**：さっき作成した起動構成を選択します。
- **サポートネットワーク**：セッションサーバーのネットワーク環境。通常、「基本ネットワーク」を選択します。
- **サポートするAvailability Zone**：即ち、拡張されたサーバーが属するAvailability Zoneを選択し、ここで、セッションサーバーが所在するAvailability Zoneに応じてチェックを入れてください。
- **除去ポリシー**：デフォルトを選択してください。
- **CLB**：セッションサーバーのCLBを選択してください。

![](https://main.qcloudimg.com/raw/a9c20b10fccb7ae63e4e23f520258dbf/dj3.png)

最後【OK】をクリックし、作成を完了します。

### 3.スケーリンググループへの既存のCVMの追加

1. [コンソール](https://console.cloud.tencent.com/autoscaling)で、スケーリンググループの名前をクリックして、管理ページに入り、ページの下方に「CVMの追加」をクリックします。
![](https://main.qcloudimg.com/raw/4df8051dbcd76ca41d9d24a20195d541.png)

2. ポップアップウィンドウで、既存のセッションサーバーを選択してスケーリンググループに追加します。
![](https://main.qcloudimg.com/raw/dd38413e9e66a21ae2a645c36f90e781/dj4.png)

3. 追加した後、サーバーを「圧縮適用外」に設定し、このように圧縮アクティビティでは、スケーリンググループは該サーバーを圧縮対象として選択しません。
![](https://mc.qcloudimg.com/static/img/62319473a1a05e98d51c64c22ca24424/0308113553.jpg)

###4. 拡張ポリシーの設定
時限拡張、またはアラームに基づく動的拡張を選択できます（通常、拡張タスクと圧縮タスクはペアで現れます）。

![](https://main.qcloudimg.com/raw/7d7fb4305f2fb13c970179dae324840b/dj5.png)

**a. 時限拡張および圧縮**：

例えば、出前注文用ミニプログラムでは、昼食の時間の負荷が他の時間よりも高いことを予想でき、ユーザーは、毎日11：00-13：00に、2つのサーバーを追加して負荷をサポートするように設定できます。

- まず、時限拡張タスクを設定します：
![](https://main.qcloudimg.com/raw/4a2f93eef612f0da6d710d640ed05140/dj7.png)

- 次に、時限圧縮タスクを設定します：
![](https://main.qcloudimg.com/raw/0fbc7d7a3ec04fd0de2333906fba1652/dj8.png)

**b. アラームに基づく拡張**：

不明瞭な拡張を予想しますが、案外のトラフィック/攻撃の発生を防ぐ必要があります：

- まず、異常なトラフィックに対応するためのアラーム拡張ポリシーを設定します：
![](https://main.qcloudimg.com/raw/2e3c81b73325fe76c912b8e021224dd3/dj9.png)

- 次に、使用率の低いサーバーを削除するためのアラーム圧縮ポリシーを設定します：
![](https://main.qcloudimg.com/raw/dbbd5ef378e123b3e51dc7ba4f2b0536/dj10.png)


## ビジネスサーバーのためのASポリシーの構成

このプロセスはセッションサーバーと同様です：

- ビジネスサーバーのために起動構成を作成します；
- ビジネスサーバーのためにスケーリンググループ「ビジネスサーバークラスタ」を作成し、ビジネスサーバーのCLBを指向します；
- ビジネスサーバーのためにスケーリングポリシーを設定します。

## スケーリング性の検証およびスケーリングアクティビティの確認
【編集】をクリックして、スケーリンググループの目標インスタンス数を+1にさせると、スケーリンググループは1つのサーバーをクラスタに自動的に拡張します。新規に拡張されたCVMがリクエストを正常に処理できれば、スケーリンググループが正常に動作することを示します。
![](https://main.qcloudimg.com/raw/d77f115c2dd5c57545b03ba188e9f27e/dj11.png)

スケーリンググループはまた、[履歴スケーリングアクティビティの照合](https://cloud.tencent.com/document/product/377/3804)をサポートし、スケーリングアクティビティの状況を完全に把握することを保証します。

ここまで、ミニプログラムは既にインテリジェント拡張機能を備えます。拡張および圧縮の問題を心配する必要がなく、スケーリンググループの通知に注意を払うか、または不定期的に履歴スケーリングアクティビティを照合するだけでよいです。

